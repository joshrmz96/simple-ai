<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clase M√°gica de Mikhail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ... (MISMOS ESTILOS QUE ANTES, SIN CAMBIOS) ... */
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        body { font-family: 'Quicksand', sans-serif; background: linear-gradient(180deg, #f0f9ff 0%, #cce7ff 100%); min-height: 100vh; color: #334155; overflow-x: hidden; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .fun-font { font-family: 'Fredoka', sans-serif; }
        nav { z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.6); position: sticky; top: 0; }
        .topic-card { background: white; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; height: 220px; border: 4px solid white; z-index: 10; display: flex; flex-direction: column; }
        .topic-image { height: 100%; width: 100%; background-size: cover; background-position: center; pointer-events: none; transition: transform 0.3s; }
        .topic-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0) 100%); padding: 16px; display: flex; flex-direction: column; justify-content: flex-end; height: 70%; pointer-events: auto; cursor: pointer; }
        .topic-btn { background: #2563eb; color: white; border-radius: 999px; padding: 6px 16px; font-size: 0.9rem; font-weight: bold; align-self: flex-start; margin-top: 8px; box-shadow: 0 2px 0 #1e3a8a; pointer-events: none; }
        .fact-card { background: white; border: 2px solid #fbbf24; border-radius: 1rem; padding: 0.8rem; margin-bottom: 1rem; box-shadow: 0 4px 0 #f59e0b; position: relative; z-index: 20; transition: all 0.3s; overflow: hidden; }
        .fact-nav-btn { background: #fef3c7; color: #d97706; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; border: 1px solid #fcd34d; flex-shrink: 0; }
        .fact-nav-btn:active { background: #d97706; color: white; transform: scale(0.9); }
        .btn-fun { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-radius: 1.5rem; padding: 1rem 1.5rem; font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 0 #1e3a8a; transition: transform 0.1s; border: none; cursor: pointer; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; }
        .btn-fun:active { transform: translateY(4px); box-shadow: 0 0 0 #1e3a8a; }
        .btn-fun:disabled { background: #94a3b8; box-shadow: none; cursor: default; transform: none; }
        .btn-secondary-fun { background: white; color: #475569; border: 3px solid #cbd5e1; border-radius: 1.5rem; padding: 0.8rem 1.5rem; font-weight: 700; transition: transform 0.2s; box-shadow: 0 4px 0 #94a3b8; cursor: pointer; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; }
        .btn-secondary-fun:active { transform: translateY(4px); box-shadow: 0 0 0 #94a3b8; }
        .btn-danger-fun { background: #fee2e2; color: #ef4444; border: 2px solid #fecaca; border-radius: 1rem; padding: 0.5rem 1rem; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; box-shadow: 0 3px 0 #fca5a5; }
        .btn-danger-fun:active { transform: translateY(3px); box-shadow: none; }
        .btn-load-more { background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; border: none; border-radius: 2rem; width: 100%; padding: 1rem; font-weight: 700; font-family: 'Fredoka', sans-serif; font-size: 1.2rem; transition: all 0.3s; cursor: pointer; margin-top: 1rem; position: relative; z-index: 20; box-shadow: 0 6px 0 #d14424; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .btn-load-more:active { transform: translateY(4px); box-shadow: 0 2px 0 #d14424; }
        .quiz-option { background: white; border: 2px solid #e2e8f0; padding: 1.2rem; border-radius: 1.2rem; cursor: pointer; transition: background 0.2s; font-weight: 600; color: #475569; font-size: 1.1rem; touch-action: manipulation; }
        .quiz-option:active { border-color: #3b82f6; background: #eff6ff; }
        .quiz-option.correct { background: #dcfce7; border-color: #22c55e; color: #15803d; }
        .quiz-option.wrong { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        #sticky-audio-player { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(200%); width: 95%; max-width: 500px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 24px; padding: 12px 20px; z-index: 2000; box-shadow: 0 10px 40px rgba(37, 99, 235, 0.25); display: flex; align-items: center; justify-content: space-between; border: 2px solid #fff; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #sticky-audio-player.visible { transform: translateX(-50%) translateY(0); }
        #assistant-btn { position: fixed; bottom: 25px; right: 20px; z-index: 3000; width: 75px; height: 75px; background-color: white; background-size: cover; background-position: center; border-radius: 50%; box-shadow: 0 6px 0 #cbd5e1, 0 10px 20px rgba(0,0,0,0.15); cursor: pointer; border: 3px solid #fff; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #assistant-btn:active { transform: scale(0.9); }
        #assistant-btn.move-up { transform: translateY(-110px); }
        .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(4px); }
        .side-menu { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: white; z-index: 5001; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 24px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .side-menu-overlay.open { opacity: 1; visibility: visible; }
        .side-menu-overlay.open .side-menu { transform: translateX(0); }
        .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 4000; display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; backdrop-filter: blur(4px); }
        .chat-overlay.open { opacity: 1; visibility: visible; }
        .chat-box { width: 100%; max-width: 400px; height: 60vh; background: white; border-radius: 32px 32px 0 0; overflow: hidden; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: none; }
        @media (min-width: 768px) { .chat-overlay { align-items: center; padding: 20px; } .chat-box { height: 550px; border-radius: 32px; transform: scale(0.95); border: 5px solid #bfdbfe; } }
        .chat-overlay.open .chat-box { transform: translateY(0); }
        @media (min-width: 768px) { .chat-overlay.open .chat-box { transform: scale(1); } }
        .search-tag { display: inline-flex; align-items: center; background: white; color: #64748b; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; border: 1px solid #e2e8f0; margin-right: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .search-tag:active { background: #eff6ff; color: #3b82f6; border-color: #bfdbfe; }
        .tag-delete { margin-left: 6px; color: #94a3b8; font-weight: bold; padding: 0 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tag-delete:hover { background: #fee2e2; color: #ef4444; }
        .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .inline-speak-btn { background: #dbeafe; color: #2563eb; border-radius: 50%; padding: 8px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px; width: 40px; height: 40px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; top: 4px; }
        .flag-icon { width: 32px; height: 24px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .read-for-me-btn { background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #bae6fd; color: #0284c7; padding: 12px 20px; border-radius: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; cursor: pointer; margin-bottom: 24px; transition: all 0.2s; box-shadow: 0 4px 0 #bae6fd; }
        .read-for-me-btn:active { transform: translateY(2px); box-shadow: none; }
        .read-for-me-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        /* Settings Modal Styles */
        .settings-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 6000; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .settings-modal-overlay.open { opacity: 1; visibility: visible; }
        .settings-modal { width: 100%; max-width: 420px; background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .settings-modal-overlay.open .settings-modal { transform: scale(1); }
        .settings-btn { background: white; border: 2px solid #e2e8f0; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; cursor: pointer; transition: all 0.2s; }
        .settings-btn:active { background: #f1f5f9; transform: scale(0.95); }
    </style>
</head>
<body class="no-select">
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/1114/1114-preview.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3" preload="auto"></audio>

    <div id="global-loader" class="fixed inset-0" style="background: #f0f9ff; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="text-7xl animate-bounce">üë©‚Äçüè´</div>
        <h2 class="text-2xl font-bold text-blue-600 mt-6 fun-font" data-i18n="preparing">Preparando tu estudio...</h2>
    </div>

    <div id="nameInputScreen" class="fixed inset-0 w-full h-full" style="display: flex; background: #fff; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; z-index: 6000;">
        <div class="absolute top-0 right-0 p-4">
            <button id="lang-toggle-intro" class="flex items-center gap-2 px-3 py-2 rounded-full bg-white border border-slate-200 active:scale-95 cursor-pointer relative z-30" onclick="playClickSound()">
                <img id="lang-flag-img-intro" src="https://flagcdn.com/w40/mx.png" alt="MX" class="flag-icon" style="width: 24px; height: 18px;">
                <span id="lang-text-intro" class="text-sm font-bold text-slate-700">ES</span>
            </button>
        </div>
        <div class="text-9xl mb-6">‚úèÔ∏è</div>
        <h2 id="namePrompt" class="text-4xl font-bold text-slate-800 fun-font mb-4 text-center">¬øCu√°l es tu nombre?</h2>
        <p id="nameSubtitle" class="text-slate-500 text-lg mb-8 text-center max-w-sm">As√≠ podr√© ser tu tutor personal.</p>
        <div class="w-full max-w-xs">
            <input type="text" id="nameInputField" class="w-full p-4 rounded-xl border-4 border-blue-200 focus:border-blue-500 outline-none text-slate-700 font-bold text-xl mb-6 text-center" placeholder="Tu Nombre">
            <button id="nameSubmitBtn" class="btn-fun w-full py-4 text-xl" onclick="playClickSound()">¬°Empezar!</button>
        </div>
    </div>

    <div id="side-menu-overlay" class="side-menu-overlay">
        <div class="side-menu">
            <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold fun-font mb-1">Tu Progreso</h2>
                    <p class="text-blue-100 text-sm">¬°Sigue aprendiendo!</p>
                </div>
                <button onclick="document.getElementById('side-menu-overlay').classList.remove('open'); playClickSound()" class="text-white bg-white/20 rounded-full w-8 h-8 flex items-center justify-center font-bold">‚úï</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto">
                <h3 class="font-bold text-slate-600 mb-2 uppercase text-xs tracking-wider">Lecciones Recientes</h3>
                <div id="menu-history-list" class="space-y-2 mb-6"></div>
                <h3 class="font-bold text-slate-600 mb-2 uppercase text-xs tracking-wider">Tus Trofeos</h3>
                <div id="menu-trophies-list" class="grid grid-cols-4 gap-2"></div>
            </div>
            <div class="p-4 border-t border-slate-100">
                <button id="reset-user-btn" class="w-full py-3 text-red-500 font-bold bg-red-50 rounded-xl active:bg-red-100" onclick="playClickSound()">Cerrar Sesi√≥n</button>
            </div>
        </div>
        <div class="absolute inset-0 z-40" onclick="document.getElementById('side-menu-overlay').classList.remove('open')"></div>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500 relative z-10" style="display:none;">
        <nav class="px-4 py-3 shadow-sm fixed top-0 left-0 right-0 max-w-6xl mx-auto" style="max-width: 100%; backdrop-filter: none; background: #f0f9ff;">
             <div class="max-w-6xl mx-auto flex items-center justify-between">
                <button id="menu-btn" class="flex items-center gap-3 active:scale-95 transition cursor-pointer" onclick="playClickSound()">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/20 text-white font-bold transform -rotate-3 border-2 border-white">M</div>
                    <div class="text-left">
                        <h1 id="app-title-display" class="text-xl font-bold text-slate-800 leading-tight fun-font" data-i18n="appTitle">Mundo [NAME]</h1>
                        <div class="flex items-center gap-1.5 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100 inline-block mt-0.5">
                            <span class="text-amber-500 text-xs">‚≠ê</span>
                            <p class="text-[10px] font-bold text-amber-700" id="points-display">0 Puntos</p>
                        </div>
                    </div>
                </button>
                <div class="flex gap-3 items-center">
                    <button id="settings-btn" class="settings-btn" onclick="openSettingsModal(); playClickSound()" title="API Settings">‚öôÔ∏è</button>
                    <button id="music-btn" class="text-xl bg-white p-2 rounded-full border border-slate-200 shadow-sm active:bg-blue-50 transition cursor-pointer" onclick="toggleMusic()">üéµ</button>
                    <button id="home-btn" class="text-2xl bg-white p-2 rounded-full border border-slate-200 shadow-sm active:bg-blue-50 transition cursor-pointer" onclick="playClickSound()">üè†</button>
                    <button id="lang-toggle" class="flex items-center gap-2 px-3 py-2 rounded-full bg-white border border-slate-200 active:scale-95 cursor-pointer relative z-30" onclick="playClickSound()">
                        <img id="lang-flag-img" src="https://flagcdn.com/w40/mx.png" alt="MX" class="flag-icon" style="width: 24px; height: 18px;">
                        <span id="lang-text" class="text-sm font-bold text-slate-700">ES</span>
                    </button>
                </div>
            </div>
        </nav>
        
        <div id="main-header" class="text-center mb-8 mt-24 transition-all duration-300">
            <h2 class="text-3xl md:text-6xl font-bold text-slate-800 fun-font mb-2 tracking-tight" id="welcome-greeting"></h2>
            <p class="text-slate-500 font-medium text-lg md:text-2xl" data-i18n="subtitle">¬øQu√© quieres descubrir hoy?</p>
        </div>

        <div id="main-tabs" class="flex justify-center mb-10 gap-4 relative z-30 transition-all duration-300">
            <button id="tab-lesson" data-view="lessonView" class="btn-fun shadow-blue-400 ring-4 ring-blue-50" onclick="playClickSound()">
                <span data-i18n="tabLessons">üìö Lecciones</span>
            </button>
            <button id="tab-quiz" data-view="quizView" class="btn-secondary-fun" onclick="playClickSound()">
                <span data-i18n="tabQuizzes">üß† Pruebas</span>
            </button>
        </div>

        <div id="lessonView" class="view block">
            <div id="discoveryContainer">
                <div class="max-w-3xl mx-auto relative z-20 mb-6">
                    <div class="fact-card">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl bg-yellow-100 p-2 rounded-lg flex-shrink-0">üí°</div>
                            <div class="flex-grow min-w-0">
                                <h3 class="font-bold text-amber-800 text-sm mb-0 fun-font flex justify-between items-center">
                                    <span data-i18n="factTitle">Curiosidad:</span>
                                    <span class="text-[10px] bg-amber-100 px-2 py-0.5 rounded text-amber-600 whitespace-nowrap" id="fact-counter">1/20</span>
                                </h3>
                                <div class="min-h-[24px] flex items-center">
                                    <p id="daily-fact" class="text-amber-900 font-medium text-sm animate-fade-in leading-snug line-clamp-2" data-i18n="loading">Cargando...</p>
                                </div>
                            </div>
                            <button class="ml-2 text-amber-500 hover:text-amber-700 text-lg flex-shrink-0 p-2" onclick="speak(document.getElementById('daily-fact').innerText)">üîä</button>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-amber-100">
                             <button id="prev-fact" class="fact-nav-btn" onclick="playClickSound()">‚¨ÖÔ∏è</button>
                             <button id="next-fact" class="fact-nav-btn" onclick="playClickSound()">‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>

                <div class="mb-6 max-w-3xl mx-auto relative z-30">
                    <div class="relative group transform transition hover:-translate-y-1">
                        <input type="text" id="topic-search" class="w-full p-4 pl-16 pr-16 rounded-full border-4 border-white shadow-xl shadow-blue-100 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 outline-none text-slate-700 font-bold text-base sm:text-xl bg-white transition" placeholder="‚ú® Busca aqu√≠... (ej: Dinosaurios)">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl opacity-40">üîç</span>
                        <div id="search-mic-container" class="absolute right-20 top-0 bottom-0 flex items-center justify-center w-12 z-50">
                            <button id="search-mic-btn" type="button" class="text-2xl text-slate-400 hover:text-blue-500 active:text-red-500 transition cursor-pointer w-full h-full flex items-center justify-center active:scale-125">üé§</button>
                        </div>
                        <button id="search-btn" class="absolute right-2 top-2 bottom-2 bg-blue-600 text-white px-6 rounded-full font-bold active:bg-blue-700 shadow-md transition text-sm sm:text-lg cursor-pointer z-40" data-i18n="go" onclick="playClickSound()">Ir</button>
                    </div>
                    <div id="search-history-container" class="mt-4 px-2 hidden">
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2" data-i18n="recent">Recientes:</p>
                        <div id="search-history-tags"></div>
                    </div>
                </div>

                <div class="flex items-center justify-center mb-8 gap-3 sm:gap-6 relative z-30 overflow-x-auto px-2 pb-2 no-scrollbar">
                     <button id="subtab-explore" class="text-blue-600 font-bold border-b-4 border-blue-600 pb-2 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üöÄ <span data-i18n="explore">Explorar</span></button>
                     <button id="subtab-branches" class="text-slate-400 font-bold border-b-4 border-transparent pb-2 active:text-slate-600 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üåø Ramas</button>
                    <button id="subtab-trophies" class="text-slate-400 font-bold border-b-4 border-transparent pb-2 active:text-slate-600 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üèÜ <span data-i18n="trophies">Trofeos</span></button>
                </div>

                <div id="section-explore">
                    <div id="clear-filter-container" class="hidden mb-4 text-center">
                        <button id="clear-filter-btn" class="text-blue-600 font-bold text-sm bg-blue-50 px-4 py-2 rounded-full hover:bg-blue-100 transition shadow-sm border border-blue-100" onclick="playClickSound()">
                            ‚¨Ö Volver a todas las Ramas
                        </button>
                    </div>
                    <div id="category-mosaics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 relative z-10"></div>
                    <button id="load-more-btn" class="btn-load-more text-lg" data-i18n="loadMore" onclick="playClickSound()">üåü ¬°Generar m√°s! üåü</button>
                </div>

                <div id="section-branches" class="hidden">
                    <div class="text-center mb-4">
                        <p class="text-slate-500 text-sm">Selecciona un tema favorito:</p>
                    </div>
                    <div id="branches-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8"></div>
                </div>

                <div id="section-trophies" class="hidden">
                     <div id="learned-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 relative z-10"></div>
                </div>
            </div>

            <div id="lessonDetailContainer" class="hidden max-w-4xl mx-auto pb-24 relative z-20 mt-2">
                <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden relative border border-slate-100">
                    <div id="lesson-header-bg" class="h-64 sm:h-96 bg-slate-100 relative w-full group">
                        <div class="absolute top-4 left-4 z-30">
                            <button id="back-button" class="flex items-center text-slate-600 active:text-blue-600 transition font-bold text-base bg-white/90 backdrop-blur-md px-5 py-2 rounded-full shadow-lg border-2 border-white group cursor-pointer hover:bg-blue-50" onclick="playClickSound()">
                                <span class="group-active:-translate-x-1 transition text-xl mr-2">‚¨ÖÔ∏è</span> <span data-i18n="back">Volver</span>
                            </button>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-6 sm:p-10 w-full z-10">
                            <h2 id="lesson-title" class="text-4xl sm:text-6xl text-white font-bold fun-font drop-shadow-xl mb-2 leading-tight">...</h2>
                        </div>
                    </div>
                    
                    <div class="p-6 sm:p-14">
                        <div id="lesson-loader" class="hidden text-center py-24">
                            <div class="text-8xl animate-bounce mb-8">‚ú®</div>
                            <p class="text-slate-700 font-bold text-2xl fun-font animate-pulse" data-i18n="preparingLesson">Robi est√° preparando la clase...</p>
                        </div>

                        <div id="lesson-error-state" class="hidden text-center py-12">
                             <div class="text-6xl mb-4">üôà</div>
                             <h3 class="text-xl font-bold text-slate-700 mb-2" data-i18n="errorTitle">¬°Ups! Se nos cay√≥ la tiza</h3>
                             <button id="retry-lesson-btn" class="btn-fun" data-i18n="retry" onclick="playClickSound()">Intentar de nuevo</button>
                        </div>

                        <div id="lesson-content-wrapper" class="hidden animate-fade-in">
                            <button id="read-for-me-btn" class="read-for-me-btn" onclick="playClickSound()">
                                <span class="text-2xl">üó£Ô∏è</span> <span class="text-lg">L√©elo por m√≠</span>
                            </button>

                            <div class="bg-blue-50/50 p-6 sm:p-10 rounded-[2rem] mb-10 border-2 border-blue-100">
                                <div class="prose max-w-none text-slate-700 leading-loose text-xl sm:text-2xl font-medium">
                                    <div id="lesson-content" class="inline">...</div>
                                </div>
                            </div>
                            <div id="lesson-questions-section" class="mb-10">
                                <h3 class="text-xl sm:text-2xl font-bold text-slate-800 fun-font mb-6 flex items-center gap-2"><span>üß©</span> <span data-i18n="letsPractice">¬°Practiquemos!</span></h3>
                                <div id="lesson-questions-list" class="space-y-6"></div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                                 <button id="generate-button" class="flex-1 btn-secondary-fun py-4 text-lg flex items-center justify-center gap-2" onclick="playClickSound()">‚ú® <span data-i18n="regenerate">Versi√≥n m√°s larga</span></button>
                                <button id="complete-button" class="flex-[2] btn-fun py-4 text-lg shadow-lg shadow-blue-500/30 text-white" onclick="playClickSound()">‚úÖ <span data-i18n="complete">¬°Termin√©!</span> (+50)</button>
                            </div>
                            <div class="mt-12 pt-8 border-t-4 border-dashed border-slate-100">
                                <div id="show-more-btn" class="text-center mb-6"><h3 class="text-xl font-bold text-slate-400" data-i18n="moreInfo">üëá Sigue explorando</h3></div>
                                <div id="more-info-section" class="flex flex-wrap justify-center gap-3 relative z-20">
                                    <div id="subcategories-list" class="flex flex-wrap justify-center gap-3 w-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="quizView" class="view hidden max-w-4xl mx-auto pb-20 relative z-20">
            <div id="quiz-placeholder" class="bg-white p-8 sm:p-12 rounded-[2rem] shadow-xl border border-slate-100 text-center py-20 sm:py-32">
                <div class="text-8xl sm:text-9xl mb-8">üß†</div>
                <h2 class="text-4xl sm:text-5xl font-bold text-slate-800 mb-4 fun-font" data-i18n="quizZone">Zona de Pruebas</h2>
                <p class="text-slate-500 text-lg sm:text-2xl max-w-lg mx-auto leading-relaxed mb-8" data-i18n="quizDesc">¬°Demuestra lo que sabes con retos sorpresa!</p>
                <div class="grid md:grid-cols-2 gap-8 text-left">
                    <div class="mb-6 md:mb-0">
                         <h3 class="font-bold text-slate-700 mb-4 text-lg" data-i18n="quizHistory">Tu Historial de Pruebas:</h3>
                         <div id="quiz-history-list" class="max-h-60 overflow-y-auto pr-2 text-sm text-slate-500"><p data-i18n="noQuizHistory">A√∫n no has hecho ninguna prueba.</p></div>
                    </div>
                    <div class="flex flex-col justify-center gap-4">
                        <button id="start-random-quiz" class="btn-fun text-lg w-full py-4" data-i18n="startQuiz" onclick="playClickSound()">üöÄ Iniciar Prueba Sorpresa</button>
                    </div>
                </div>
            </div>
            
            <div id="quiz-container" class="hidden">
                <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-100 p-6 sm:p-14">
                    <div class="flex justify-between items-center mb-8 border-b-2 border-slate-100 pb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 fun-font" id="quiz-topic-title">Cargando...</h2>
                        <div class="flex gap-2 items-center">
                            <button onclick="exitQuiz(); playClickSound()" class="btn-danger-fun" data-i18n="exit">Salir</button>
                        </div>
                    </div>
                    <div id="quiz-questions-list" class="space-y-6"></div>
                    <button id="finish-quiz-btn" class="hidden mt-8 w-full btn-fun text-lg py-4" data-i18n="saveResult" onclick="playClickSound()">Guardar Resultado</button>
                    <div id="quiz-result" class="hidden mt-8 p-6 bg-green-50 rounded-[2rem] border-2 border-green-200 text-center animate-fade-in">
                        <p class="text-3xl sm:text-4xl font-bold text-green-600 fun-font mb-2" data-i18n="quizFinished">¬°Prueba Finalizada! üéâ</p>
                        <p class="text-green-700 font-bold text-xl" id="quiz-score-text">+30 Puntos</p>
                        <button onclick="exitQuiz(); playClickSound()" class="mt-6 btn-secondary-fun" data-i18n="backQuiz">Volver</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AUDIO PLAYER -->
    <div id="sticky-audio-player">
        <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-full flex items-center justify-center text-white text-2xl shadow-lg border-4 border-white animate-pulse flex-shrink-0">üë©‚Äçüè´</div>
        <div class="flex-grow mx-4 overflow-hidden">
            <p class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-0.5" data-i18n="profGemini">PROFE AI</p>
            <p class="text-sm font-bold text-slate-800 truncate" id="player-status" data-i18n="loadingVoice">Cargando voz...</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="player-play-pause" class="w-12 h-12 rounded-full bg-slate-900 text-white font-bold text-xl active:bg-slate-700 shadow-md transition-all flex items-center justify-center cursor-pointer" onclick="playClickSound()">‚è∏</button>
            <button id="player-close" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 active:bg-red-100 active:text-red-500 font-bold text-sm flex items-center justify-center transition-colors cursor-pointer" onclick="playClickSound()">‚úï</button>
        </div>
    </div>

    <!-- MUSICA DE FONDO (URL ESTABLE DE ARCHIVO MP3) -->
    <audio id="bg-music" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <button id="assistant-btn" onclick="playClickSound()"></button>

    <div class="chat-overlay" id="chat-overlay">
        <div class="chat-box">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div id="chat-header-icon" class="w-10 h-10 bg-white rounded-full bg-cover bg-center border-2 border-white"></div>
                    <div>
                        <h3 class="font-bold text-lg fun-font">Robi</h3>
                        <div class="flex items-center gap-2">
                            <p class="text-[10px] text-blue-200 font-medium" data-i18n="personalTutor">Tu Profe Personal</p>
                            <button class="bg-blue-500 active:bg-blue-400 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider" title="Historial Guardado" data-i18n="historyBtn">üìú Historial</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="minimize-chat" class="text-white/70 active:text-white active:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold mb-2 transition cursor-pointer" onclick="playClickSound()">_</button>
                    <button id="close-chat" class="text-white/70 active:text-white active:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center text-2xl transition cursor-pointer" onclick="playClickSound()">‚úï</button>
                </div>
            </div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 bg-slate-50 text-base"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2 items-center flex-shrink-0 pb-6 md:pb-3">
                <button id="voice-chat-btn" class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 active:bg-blue-600 active:text-white transition flex items-center justify-center flex-shrink-0 text-xl shadow-sm border-2 border-transparent cursor-pointer">üé§</button>
                <input type="text" id="chat-input" class="flex-grow bg-slate-100 rounded-full px-4 py-2 outline-none focus:ring-4 focus:ring-blue-100 text-base h-12 text-slate-700 placeholder-slate-400" placeholder="Escribe tu duda...">
                <button id="send-chat" class="bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg active:bg-blue-700 flex items-center justify-center flex-shrink-0 text-xl transform active:scale-95 transition cursor-pointer" onclick="playClickSound()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL FOR API KEYS -->
    <div id="settings-modal-overlay" class="settings-modal-overlay">
        <div class="settings-modal">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <h3 class="font-bold text-lg fun-font" id="settings-title">Configuraci√≥n API</h3>
                </div>
                <button onclick="closeSettingsModal(); playClickSound()" class="text-white/70 active:text-white active:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center text-2xl transition cursor-pointer">‚úï</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                <p class="text-sm text-slate-500 mb-4" id="settings-desc">Ingresa tus claves API para habilitar las funciones de IA. Las claves se guardan localmente en tu navegador.</p>
                
                <!-- OpenAI -->
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">ü§ñ OpenAI (ChatGPT) - Prioridad 1</label>
                    <input type="password" id="input-openai-key" class="w-full p-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 outline-none text-slate-700 text-sm" placeholder="sk-...">
                </div>

                <!-- Gemini -->
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">‚ú® Google Gemini - Prioridad 2</label>
                    <input type="password" id="input-gemini-key" class="w-full p-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 outline-none text-slate-700 text-sm" placeholder="AIza...">
                </div>

                <!-- Grok -->
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">üöÄ Grok (xAI) - Prioridad 3</label>
                    <input type="password" id="input-grok-key" class="w-full p-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 outline-none text-slate-700 text-sm" placeholder="xai-...">
                </div>

                <!-- Murf.ai -->
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">üó£Ô∏è Murf.ai (Voz/TTS)</label>
                    <input type="password" id="input-murf-key" class="w-full p-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 outline-none text-slate-700 text-sm" placeholder="murf_...">
                    <p class="text-xs text-slate-400">Voces femeninas: Espa√±ol (M√©xico) y Ingl√©s (EE.UU.)</p>
                </div>

                <div class="pt-4 border-t border-slate-100">
                    <button onclick="saveSettings(); playClickSound()" class="btn-fun w-full py-3">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>

                <div class="text-center">
                    <p class="text-xs text-slate-400 mt-4">üîí Tus claves se guardan solo en este dispositivo</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =====================================================
        // API CONFIGURATION - PLUG IN YOUR API KEYS HERE
        // DO NOT HARDCODE REAL KEYS - Use placeholders or settings modal
        // =====================================================
        const API_CONFIG = {
            // OpenAI (ChatGPT) - Priority 1
            openai: {
                apiKey: localStorage.getItem('openai_api_key') || 'YOUR_OPENAI_API_KEY',
                endpoint: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-3.5-turbo'
            },
            // Google Gemini - Priority 2
            gemini: {
                apiKey: localStorage.getItem('gemini_api_key') || 'YOUR_GEMINI_API_KEY',
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            },
            // Grok (xAI) - Priority 3
            grok: {
                apiKey: localStorage.getItem('grok_api_key') || 'YOUR_GROK_API_KEY',
                endpoint: 'https://api.x.ai/v1/chat/completions',
                model: 'grok-beta'
            },
            // Murf.ai - Voice/TTS
            murf: {
                apiKey: localStorage.getItem('murf_api_key') || 'YOUR_MURF_API_KEY',
                endpoint: 'https://api.murf.ai/v1/speech/generate'
            }
        };

        // Voice settings for Murf.ai - Female voices
        // Murf.ai voice IDs - check https://murf.ai/api/docs for latest voice options
        const VOICE_SETTINGS = {
            es: {
                // Spanish (Mexico) - Female voice
                voiceId: 'es-MX-sofia', // Murf.ai female voice for Spanish MX
                language: 'es-MX',
                gender: 'female'
            },
            en: {
                // English (United States) - Female voice
                voiceId: 'en-US-natalie', // Murf.ai female voice for English US
                language: 'en-US',
                gender: 'female'
            }
        };

        // =====================================================
        // API INTEGRATION FUNCTIONS WITH FALLBACK LOGIC
        // Priority: ChatGPT ‚Üí Gemini ‚Üí Grok
        // =====================================================

        // Check if an API key is configured (not placeholder)
        function isApiKeyConfigured(key) {
            return key && !key.startsWith('YOUR_') && key.trim() !== '';
        }

        // OpenAI (ChatGPT) API call
        async function callOpenAI(prompt, systemPrompt = '') {
            if (!isApiKeyConfigured(API_CONFIG.openai.apiKey)) {
                throw new Error('OpenAI API key not configured');
            }
            
            const messages = [];
            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }
            messages.push({ role: 'user', content: prompt });

            const response = await fetch(API_CONFIG.openai.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.openai.apiKey}`
                },
                body: JSON.stringify({
                    model: API_CONFIG.openai.model,
                    messages: messages,
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Google Gemini API call
        async function callGemini(prompt, systemPrompt = '') {
            if (!isApiKeyConfigured(API_CONFIG.gemini.apiKey)) {
                throw new Error('Gemini API key not configured');
            }

            const fullPrompt = systemPrompt ? `${systemPrompt}\n\n${prompt}` : prompt;
            const url = `${API_CONFIG.gemini.endpoint}?key=${API_CONFIG.gemini.apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 1500,
                        temperature: 0.7
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Grok (xAI) API call
        async function callGrok(prompt, systemPrompt = '') {
            if (!isApiKeyConfigured(API_CONFIG.grok.apiKey)) {
                throw new Error('Grok API key not configured');
            }

            const messages = [];
            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }
            messages.push({ role: 'user', content: prompt });

            const response = await fetch(API_CONFIG.grok.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.grok.apiKey}`
                },
                body: JSON.stringify({
                    model: API_CONFIG.grok.model,
                    messages: messages,
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`Grok API error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Main text generation function with fallback logic
        // Priority: ChatGPT ‚Üí Gemini ‚Üí Grok
        async function generateText(prompt, systemPrompt = '') {
            const providers = [
                { name: 'OpenAI', fn: callOpenAI },
                { name: 'Gemini', fn: callGemini },
                { name: 'Grok', fn: callGrok }
            ];

            let lastError = null;

            for (const provider of providers) {
                try {
                    console.log(`Trying ${provider.name}...`);
                    const result = await provider.fn(prompt, systemPrompt);
                    console.log(`${provider.name} succeeded`);
                    return { text: result, provider: provider.name };
                } catch (error) {
                    console.log(`${provider.name} failed:`, error.message);
                    lastError = error;
                    // Continue to next provider
                }
            }

            // All providers failed - return a graceful fallback message
            console.log('All AI providers failed, using fallback response');
            return {
                text: getFallbackResponse(prompt),
                provider: 'fallback'
            };
        }

        // Fallback response when all APIs fail
        function getFallbackResponse(prompt) {
            const lang = state.lang || 'es';
            if (lang === 'es') {
                return `¬°Hola! Parece que los servicios de IA no est√°n disponibles en este momento. Por favor, configura tus claves de API en el men√∫ de ajustes (‚öôÔ∏è) para disfrutar de contenido personalizado. Mientras tanto, ¬°sigue explorando los temas disponibles!`;
            }
            return `Hi! It seems the AI services are not available right now. Please configure your API keys in the settings menu (‚öôÔ∏è) to enjoy personalized content. In the meantime, keep exploring the available topics!`;
        }

        // =====================================================
        // MURF.AI VOICE/TTS INTEGRATION
        // Female voices for Spanish (MX) and English (US)
        // =====================================================

        async function generateVoiceWithMurf(text, language = 'es') {
            if (!isApiKeyConfigured(API_CONFIG.murf.apiKey)) {
                throw new Error('Murf.ai API key not configured');
            }

            const voiceSettings = VOICE_SETTINGS[language] || VOICE_SETTINGS.es;
            const cleanText = stripEmojis(text);

            const response = await fetch(API_CONFIG.murf.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.murf.apiKey}`
                },
                body: JSON.stringify({
                    voiceId: voiceSettings.voiceId,
                    text: cleanText,
                    format: 'MP3',
                    sampleRate: 24000,
                    style: 'Conversational'
                })
            });

            if (!response.ok) {
                throw new Error(`Murf.ai API error: ${response.status}`);
            }

            const data = await response.json();
            return data.audioFile; // URL or base64 audio
        }

        // Voice generation with fallback to browser TTS
        async function generateVoice(text, language = 'es') {
            try {
                // Try Murf.ai first
                const audioUrl = await generateVoiceWithMurf(text, language);
                return { audioUrl, provider: 'murf' };
            } catch (error) {
                console.log('Murf.ai voice failed, falling back to browser TTS:', error.message);
                // Fallback to browser's built-in speech synthesis
                return { useBrowserTTS: true, text, language, provider: 'browser' };
            }
        }

        // Browser TTS fallback function
        function speakWithBrowserTTS(text, language = 'es') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(stripEmojis(text));
                utterance.lang = language === 'es' ? 'es-MX' : 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.1; // Slightly higher pitch for female-like voice
                
                // Try to find a female voice
                const voices = speechSynthesis.getVoices();
                const femaleVoice = voices.find(v => 
                    v.lang.startsWith(language) && 
                    (v.name.toLowerCase().includes('female') || 
                     v.name.toLowerCase().includes('mujer') ||
                     v.name.toLowerCase().includes('woman'))
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                speechSynthesis.speak(utterance);
                return true;
            }
            return false;
        }

        // Main speak function that handles all voice scenarios
        async function speak(text) {
            if (!text || text.trim() === '') return;
            
            const language = state.lang || 'es';
            
            try {
                const result = await generateVoice(text, language);
                
                if (result.useBrowserTTS) {
                    // Use browser TTS as fallback
                    speakWithBrowserTTS(result.text, result.language);
                    updatePlayerStatus(i18n[state.lang].voiceBasic || 'Basic voice...');
                } else if (result.audioUrl) {
                    // Play Murf.ai audio
                    playAudioFromUrl(result.audioUrl);
                    updatePlayerStatus('Murf.ai');
                }
            } catch (error) {
                console.log('Voice generation failed completely:', error);
                // Silent fail - no error shown to user
                speakWithBrowserTTS(text, language);
            }
        }

        // Helper to play audio from URL
        function playAudioFromUrl(url) {
            const audio = new Audio(url);
            audio.play().catch(err => {
                console.log('Audio playback failed:', err);
                // Fallback to browser TTS on playback error
                if (state.currentText) {
                    speakWithBrowserTTS(state.currentText, state.lang);
                }
            });
        }

        // Update player status display
        function updatePlayerStatus(status) {
            const playerStatus = document.getElementById('player-status');
            if (playerStatus) {
                playerStatus.textContent = status;
            }
        }

        // =====================================================
        // SETTINGS MODAL FOR API KEYS
        // =====================================================

        function saveApiKeys(openai, gemini, grok, murf) {
            if (openai) localStorage.setItem('openai_api_key', openai);
            if (gemini) localStorage.setItem('gemini_api_key', gemini);
            if (grok) localStorage.setItem('grok_api_key', grok);
            if (murf) localStorage.setItem('murf_api_key', murf);
            
            // Update API_CONFIG
            API_CONFIG.openai.apiKey = openai || API_CONFIG.openai.apiKey;
            API_CONFIG.gemini.apiKey = gemini || API_CONFIG.gemini.apiKey;
            API_CONFIG.grok.apiKey = grok || API_CONFIG.grok.apiKey;
            API_CONFIG.murf.apiKey = murf || API_CONFIG.murf.apiKey;
        }

        function openSettingsModal() {
            document.getElementById('settings-modal-overlay').classList.add('open');
            // Load current values
            document.getElementById('input-openai-key').value = 
                isApiKeyConfigured(API_CONFIG.openai.apiKey) ? API_CONFIG.openai.apiKey : '';
            document.getElementById('input-gemini-key').value = 
                isApiKeyConfigured(API_CONFIG.gemini.apiKey) ? API_CONFIG.gemini.apiKey : '';
            document.getElementById('input-grok-key').value = 
                isApiKeyConfigured(API_CONFIG.grok.apiKey) ? API_CONFIG.grok.apiKey : '';
            document.getElementById('input-murf-key').value = 
                isApiKeyConfigured(API_CONFIG.murf.apiKey) ? API_CONFIG.murf.apiKey : '';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal-overlay').classList.remove('open');
        }

        function saveSettings() {
            const openai = document.getElementById('input-openai-key').value.trim();
            const gemini = document.getElementById('input-gemini-key').value.trim();
            const grok = document.getElementById('input-grok-key').value.trim();
            const murf = document.getElementById('input-murf-key').value.trim();
            
            saveApiKeys(openai, gemini, grok, murf);
            closeSettingsModal();
            
            // Show confirmation with toast notification
            const confirmMsg = state.lang === 'es' ? '¬°Configuraci√≥n guardada!' : 'Settings saved!';
            showToast(confirmMsg);
        }

        // Toast notification function
        function showToast(message, duration = 3000) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg z-[7000] font-bold text-sm animate-fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Expose functions globally
        window.speak = speak;
        window.generateText = generateText;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.saveSettings = saveSettings;
        window.showToast = showToast;

        // APIS - AQUI ES DONDE OCURRE LA MAGIA
        // IMPORTANTE: EL PROXY ES SOLO PARA DEMOSTRACI√ìN. EN PRODUCCION USA SERVERLESS
        
        const robiIconUrl = "https://image.pollinations.ai/prompt/cute%203d%20avatar%20young%20female%20teacher%20low%20ponytail%20black%20hair%20black%20glasses%20friendly%20icon%20soft%20lighting?width=150&height=150&nologo=true";

        const BRANCHES = [
            { name: "Ciencia", icon: "üî¨" }, { name: "Historia", icon: "üè∫" }, { name: "Espacio", icon: "üöÄ" },
            { name: "Arte", icon: "üé®" }, { name: "Animales", icon: "ü¶Å" }, { name: "Tecnolog√≠a", icon: "üíª" },
            { name: "Naturaleza", icon: "üå≥" }, { name: "M√∫sica", icon: "üéµ" }, { name: "Geograf√≠a", icon: "üåç" },
            { name: "Deportes", icon: "‚öΩ" }, { name: "Matem√°ticas", icon: "‚ûó" }, { name: "Literatura", icon: "üìö" },
            { name: "Cuerpo", icon: "ü¶¥" }, { name: "Oc√©anos", icon: "üê≥" }, { name: "Profesiones", icon: "üë©‚Äçüöí" },
            { name: "Veh√≠culos", icon: "üöó" }, { name: "Comida", icon: "üçï" }, { name: "Inventos", icon: "üí°" }
        ];

        // SUBTEMAS DEFINIDOS PARA CADA RAMA (Filtrado Inteligente)
        const BRANCH_TOPICS = {
            "Ciencia": ["Volcanes", "Electricidad", "Imanes", "Microscopios", "Qu√≠mica", "F√≠sica", "El Clima", "Arco√≠ris", "√Åtomos"],
            "Historia": ["Egipto", "Castillos", "Vikingos", "Romanos", "Mayas", "Griegos", "Caballeros", "Pir√°mides", "Reyes"],
            "Espacio": ["Planetas", "La Luna", "El Sol", "Estrellas", "Agujeros Negros", "Cohetes", "Astronautas", "Galaxias", "Cometas"],
            "Arte": ["Pintura", "Leonardo da Vinci", "Colores", "Museos", "Fotograf√≠a", "Cine", "Dibujos", "Teatro", "Escultura"],
            "Animales": ["Dinosaurios", "Tiburones", "Insectos", "Mam√≠feros", "Aves", "Reptiles", "Osos Polares", "Leones", "Mariposas"],
            "Tecnolog√≠a": ["Robots", "Trenes", "Aviones", "Computadoras", "Internet", "Videojuegos", "Coches", "IA", "Tel√©fonos"],
            "Naturaleza": ["Lluvia", "Bosques", "Monta√±as", "R√≠os", "Desiertos", "Flores", "Reciclaje", "Arboles", "Plantas"],
            "M√∫sica": ["Instrumentos", "Mozart", "Beethoven", "Ritmo", "Orquesta", "Canciones", "√ìpera", "Rock", "Piano"],
            "Geograf√≠a": ["Mapas", "Banderas", "Capitales", "Continentes", "Oc√©anos", "Volcanes", "Ciudades", "Selvas", "Polos"],
            "Deportes": ["F√∫tbol", "Baloncesto", "Nataci√≥n", "Olimpiadas", "Tenis", "Gimnasia", "Karate", "B√©isbol", "Carreras"],
            "Matem√°ticas": ["Sumas", "Restas", "Formas", "N√∫meros", "Medidas", "Reloj", "Dinero", "Fracciones", "Geometr√≠a"],
            "Literatura": ["Cuentos", "Poemas", "F√°bulas", "Don Quijote", "Harry Potter", "Leyendas", "Mitos", "Libros", "Escritores"],
            "Cuerpo": ["Cerebro", "Coraz√≥n", "Huesos", "M√∫sculos", "Sentidos", "Dientes", "Digesti√≥n", "ADN", "C√©lulas"],
            "Oc√©anos": ["Ballenas", "Corales", "Submarinos", "Playas", "Olas", "Medusas", "Pulpos", "Barcos", "Icebergs"],
            "Profesiones": ["Bomberos", "M√©dicos", "Polic√≠as", "Maestros", "Cient√≠ficos", "Artistas", "Granjeros", "Pilotos", "Chefs"],
            "Veh√≠culos": ["Coches", "Camiones", "Barcos", "Aviones", "Helic√≥pteros", "Bicicletas", "Motos", "Autobuses", "Tractores"],
            "Comida": ["Frutas", "Verduras", "Pan", "Chocolate", "Pizza", "Vitaminas", "Cocina", "Postres", "Desayuno"],
            "Inventos": ["Rueda", "Bombilla", "Tel√©fono", "Imprenta", "Internet", "Br√∫jula", "Reloj", "C√°mara", "Papel"]
        };

        const STATIC_TOPICS_ES = ["Los Planetas", "Dinosaurios", "Volcanes", "El Oc√©ano", "El Cuerpo Humano", "Antiguo Egipto", "Los Robots", "La Electricidad", "Animales Polares", "La Lluvia", "Las Abejas", "El Espacio", "Los Castillos", "Las Pir√°mides", "Los Tiburones", "La Fotos√≠ntesis", "La Gravedad", "Los Trenes", "Los Aviones", "Los Bosques"];
        const STATIC_TOPICS_EN = ["The Planets", "Dinosaurs", "Volcanoes", "The Ocean", "Human Body", "Ancient Egypt", "Robots", "Electricity", "Polar Animals", "Rain", "Bees", "Space", "Castles", "Pyramids", "Sharks", "Photosynthesis", "Gravity", "Trains", "Airplanes", "Forests"];
        const BASE_FACTS = [ { es: "Las abejas bailan para decir d√≥nde est√°n las flores.", en: "Bees dance to tell where flowers are." }, { es: "El coraz√≥n de un camar√≥n est√° en su cabeza.", en: "A shrimp's heart is in its head." }, { es: "Los delfines duermen con un ojo abierto.", en: "Dolphins sleep with one eye open." }, { es: "Venus es el planeta m√°s caliente del sistema solar.", en: "Venus is the hottest planet in the solar system." }, { es: "Los pulpos tienen 3 corazones.", en: "Octopuses have 3 hearts." } ];

        const state = { lang: localStorage.getItem('appLang') || 'es', userName: localStorage.getItem('userName') || null, points: 0, history: [], quizHistory: [], currentLesson: null, audioCache: new Map(), audioSource: null, isPlaying: false, currentText: "", itemsToShow: 9, isVoiceActive: false, isNative: false, currentFacts: [], currentFactIndex: 0, searchHistory: [], chatHistory: [], currentBranch: null };

        const i18n = {
            es: { preparing: "Preparando...", appTitle: "Mundo [NAME]", welcome: "¬°Hola, [NAME]! üëã", subtitle: "¬øQu√© quieres descubrir hoy?", tabLessons: "üìö Lecciones", tabQuizzes: "üß† Pruebas", factTitle: "Curiosidad:", loading: "Cargando...", go: "Ir", recent: "Recientes:", explore: "Explorar", trophies: "Trofeos", loadMore: "üåü ¬°Generar m√°s! üåü", back: "Volver", preparingLesson: "Robi est√° preparando la clase...", errorTitle: "¬°Ups!", errorDesc: "Robi tuvo un problema.", retry: "Reintentar", letsPractice: "¬°Practiquemos!", regenerate: "Versi√≥n m√°s larga", complete: "¬°Termin√©!", moreInfo: "üëá Sigue explorando", quizZone: "Zona de Pruebas", quizDesc: "¬°Demuestra lo que sabes!", quizHistory: "Tu Historial:", noQuizHistory: "Sin pruebas.", startQuiz: "üöÄ Iniciar Prueba", goToStudy: "Ir a Estudiar", finalExam: "Examen Final", exit: "Salir", saveResult: "Guardar Resultado", quizFinished: "¬°Finalizada! üéâ", backQuiz: "Volver", profGemini: "PROFE AI", loadingVoice: "Cargando voz...", personalTutor: "Tu Profe Personal", historyBtn: "üìú Historial", chatPlaceholder: "Escribe tu duda...", searchPlaceholder: "‚ú® Busca aqu√≠...", points: "Puntos", won: "GANADO", question: "Pregunta", correct: "¬°Correcto!", tryAgain: "Intenta otra vez", thinking: "Pensando...", voiceBasic: "Voz b√°sica...", greeting: "¬°Hola! Soy Robi. üçé", namePrompt: "¬øCu√°l es tu nombre?", nameSubtitle: "Ser√© tu tutor personal.", nameSubmit: "¬°Empezar!" },
            en: { preparing: "Preparing...", appTitle: "[NAME]'s World", welcome: "Hello, [NAME]! üëã", subtitle: "Discover today?", tabLessons: "üìö Lessons", tabQuizzes: "üß† Quizzes", factTitle: "Fun Fact:", loading: "Loading...", go: "Go", recent: "Recent:", explore: "Explore", trophies: "Trophies", loadMore: "üåü Generate more! üåü", back: "Back", preparingLesson: "Robi is preparing...", errorTitle: "Oops!", errorDesc: "Problem.", retry: "Retry", letsPractice: "Let's Practice!", regenerate: "Longer Version", complete: "Done!", moreInfo: "üëá Explore", quizZone: "Quiz Zone", quizDesc: "Show knowledge!", quizHistory: "History:", noQuizHistory: "No quizzes.", startQuiz: "üöÄ Start Quiz", goToStudy: "Go Study", finalExam: "Exam", exit: "Exit", saveResult: "Save", quizFinished: "Finished! üéâ", backQuiz: "Back", profGemini: "GEMINI", loadingVoice: "Loading voice...", personalTutor: "Tutor", historyBtn: "üìú History", chatPlaceholder: "Type...", searchPlaceholder: "‚ú® Search...", points: "Points", won: "WON", question: "Question", correct: "Correct!", tryAgain: "Try again", thinking: "Thinking...", voiceBasic: "Basic voice...", greeting: "Hi! I'm Robi. üçé", namePrompt: "Name?", nameSubtitle: "Your tutor.", nameSubmit: "Start!" }
        };

        window.b64ToBuf = function(b64) { const bin=atob(b64); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
        window.pcmToWav = function(pcm) { const buf=new ArrayBuffer(44+pcm.length*2); const view=new DataView(buf); const writeString=(o,s)=>{for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i))}; writeString(0,'RIFF');view.setUint32(4,36+pcm.length*2,true);writeString(8,'WAVE');writeString(12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,1,true);view.setUint32(24,24000,true);view.setUint32(28,48000,true);view.setUint16(32,2,true);view.setUint16(34,16,true);writeString(36,'data');view.setUint32(40,pcm.length*2,true);for(let i=0;i<pcm.length;i++)view.setInt16(44+i*2,pcm[i],true);return new Blob([view],{type:'audio/wav'}); }
        
        function stripEmojis(str) {
            if(!str) return "";
            return str.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
        }

        // --- HELPER PARA SONIDOS ---
        function playClickSound() { document.getElementById('sfx-click').play().catch(()=>{}); }
        function playWinSound() { document.getElementById('sfx-win').play().catch(()=>{}); }
        function playCorrectSound() { document.getElementById('sfx-correct').play().catch(()=>{}); }
        function playWrongSound() { document.getElementById('sfx-wrong').play().catch(()=>{}); }
        
        // Expose sound functions globally for onclick handlers
        window.playClickSound = playClickSound;
        window.playWinSound = playWinSound;
        window.playCorrectSound = playCorrectSound;
        window.playWrongSound = playWrongSound;
        
        function toggleMusic() {
            const bg = document.getElementById('bg-music');
            const btn = document.getElementById('music-btn');
            if(bg.paused) {
                bg.volume = 0.05; // VOLUMEN AL 5%
                bg.play().catch(()=>{});
                btn.innerText = "üéµ";
                btn.style.opacity = "1";
            } else {
                bg.pause();
                btn.innerText = "üîá";
                btn.style.opacity = "0.5";
            }
        }
        
        // Expose toggleMusic globally
        window.toggleMusic = toggleMusic;

        function updateUI() {
            const t = i18n[state.lang];
            const userName = state.userName || 'Mikhail';
            
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.textContent = t[key]; });
            
            document.getElementById('welcome-greeting').textContent = t.welcome.replace('[NAME]', userName);
            document.getElementById('app-title-display').textContent = t.appTitle.replace('[NAME]', userName);

            document.getElementById('topic-search').placeholder = t.searchPlaceholder;
            document.getElementById('chat-input').placeholder = t.chatPlaceholder;
            const nameField = document.getElementById('nameInputField'); if(nameField) nameField.placeholder = state.lang === 'es' ? 'Tu Nombre' : 'Your Name';
            const flagSrc = state.lang === 'es' ? 'https://flagcdn.com/w40/mx.png' : 'https://flagcdn.com/w40/us.png';
            const langText = state.lang.toUpperCase();
            if (document.getElementById('lang-toggle')) { document.querySelector('#lang-toggle .flag-icon').src = flagSrc; document.querySelector('#lang-toggle span').textContent = langText; }
            if (document.getElementById('lang-toggle-intro')) { document.querySelector('#lang-toggle-intro .flag-icon').src = flagSrc; document.querySelector('#lang-toggle-intro span').textContent = langText; }
            document.getElementById('points-display').textContent = `${state.points} ${t.points}`;
            document.getElementById('assistant-btn').style.backgroundImage = `url('${robiIconUrl}')`;
            document.getElementById('chat-header-icon').style.backgroundImage = `url('${robiIconUrl}')`;
            updateFactUI(); renderMosaics(); renderBranches(); renderHistory(); renderQuizHistory(); renderSearchHistory(); renderMenuHistory();
        }

        function getImageUrl(topicEn) { 
            return `https://image.pollinations.ai/prompt/illustration%20of%20${encodeURIComponent(topicEn)}%20vector%20flat%20colorful?width=600&height=400&nologo=true`; 
        }

        function initFacts() { state.currentFacts = [...BASE_FACTS].sort(() => 0.5 - Math.random()).slice(0, 5); state.currentFactIndex = 0; updateFactUI(); }
        function getTranslatedFact(factObj) { return factObj[state.lang] || factObj.es; }
        function updateFactUI() { if(state.currentFacts.length === 0) initFacts(); const factObj = state.currentFacts[state.currentFactIndex]; const factText = getTranslatedFact(factObj); const el = document.getElementById('daily-fact'); el.style.opacity = '0'; setTimeout(() => { el.innerText = factText; el.style.opacity = '1'; document.getElementById('fact-counter').innerText = `${state.currentFactIndex + 1}/5`; }, 200); }
        document.getElementById('next-fact').onclick = () => { if(state.currentFactIndex < 4) { state.currentFactIndex++; updateFactUI(); } else { state.currentFacts = [...BASE_FACTS].sort(() => 0.5 - Math.random()).slice(0, 5); state.currentFactIndex = 0; updateFactUI(); } };
        document.getElementById('prev-fact').onclick = () => { if(state.currentFactIndex > 0) { state.currentFactIndex--; updateFactUI(); } };

        function renderMosaics(topicList = null, containerId = 'category-mosaics') {
            const container = document.getElementById(containerId); 
            if(!container) return;
            if (!topicList && state.itemsToShow === 9) container.innerHTML = '';
            else if(topicList) container.innerHTML = ''; 

            const list = topicList || (state.lang === 'es' ? STATIC_TOPICS_ES : STATIC_TOPICS_EN);
            
            let start = 0;
            let end = list.length;
            
            if (!topicList) {
                if(state.itemsToShow > 9 && container.children.length > 0) start = container.children.length;
                end = Math.min(state.itemsToShow, list.length);
            }

            for(let i=start; i < end; i++) {
                const topic = list[i]; 
                const topicEn = topic; 
                const img = getImageUrl(topicEn);
                
                const card = document.createElement('div'); 
                card.className = "topic-card animate-fade-in"; 
                
                card.innerHTML = `
                    <div class="topic-image" style="background-image: url('${img}')"></div>
                    <div class="topic-overlay">
                        <span class="font-bold text-white text-2xl fun-font drop-shadow-md tracking-wide mb-1 leading-tight">${topic}</span>
                        <button class="topic-btn">Ver Lecci√≥n</button>
                    </div>
                `;
                const load = () => loadLesson(topic, topic, topicEn, img, false);
                const overlay = card.querySelector('.topic-overlay');
                overlay.onclick = (e) => { e.stopPropagation(); playClickSound(); load(); };
                container.appendChild(card);
            }
            
            const loadMoreBtn = document.getElementById('load-more-btn');
            if(loadMoreBtn) {
                loadMoreBtn.style.display = 'block';
                if(topicList) {
                    loadMoreBtn.innerText = "üåü ¬°Generar nuevos temas! üåü";
                    loadMoreBtn.onclick = () => { playClickSound(); generateMoreTopicsForBranch(); };
                } else {
                    loadMoreBtn.innerText = "üåü ¬°Ver m√°s cosas! üåü";
                    loadMoreBtn.onclick = () => { playClickSound(); state.itemsToShow += 9; renderMosaics(null, 'category-mosaics'); };
                }
            }
        }

        async function generateMoreTopicsForBranch() {
            // Placeholder for generation logic
        }

        function renderBranches() {
            const container = document.getElementById('branches-grid'); 
            if(!container) return;
            container.innerHTML = '';
            BRANCHES.forEach(branch => {
                const btn = document.createElement('div');
                btn.className = "bg-white border-2 border-slate-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-sm hover:border-blue-300 transition hover:shadow-md h-32 active:scale-95";
                btn.innerHTML = `<div class="text-4xl mb-1">${branch.icon}</div><span class="font-bold text-slate-700 text-center text-sm">${branch.name}</span>`;
                btn.onclick = () => { 
                    playClickSound();
                    document.getElementById('section-branches').classList.add('hidden');
                    document.getElementById('section-explore').classList.remove('hidden');
                    document.getElementById('clear-filter-container').classList.remove('hidden');
                    
                    const subtopics = BRANCH_TOPICS[branch.name] || ["General"];
                    state.currentBranch = branch.name;
                    renderMosaics(subtopics, 'category-mosaics');
                    
                    document.getElementById('subtab-explore').classList.add('text-blue-600','border-blue-600'); 
                    document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600');
                };
                container.appendChild(btn);
            });
        }

        document.getElementById('clear-filter-btn').onclick = () => {
            playClickSound();
            document.getElementById('clear-filter-container').classList.add('hidden');
            state.currentBranch = null;
            state.itemsToShow = 9; 
            document.getElementById('category-mosaics').innerHTML = '';
            renderMosaics(null, 'category-mosaics');
        };

        function renderHistory() {
            const cont = document.getElementById('learned-gallery'); if(!cont) return; cont.innerHTML = ''; if(state.history.length === 0) { cont.innerHTML = `<p class="text-slate-400 font-medium text-center col-span-full py-8 text-xl">...</p>`; return; }
            const t = i18n[state.lang];
            state.history.forEach(item => { const card = document.createElement('div'); card.className = "bg-white border-0 rounded-2xl p-4 flex flex-col justify-between h-32 active:scale-95 transition cursor-pointer relative overflow-hidden group shadow-md"; card.innerHTML = `<div class="absolute top-0 right-0 px-3 py-1 bg-amber-400 text-white rounded-bl-xl text-xs font-bold shadow-sm">üèÜ ${t.won}</div><h3 class="font-bold text-slate-700 text-lg group-hover:text-blue-600 line-clamp-2">${item.displayTopic}</h3><p class="text-xs text-slate-400 font-bold">${new Date(item.date).toLocaleDateString()}</p>`; card.onclick = () => loadLesson(item.displayTopic, item.topicEs, item.topicEn, getImageUrl(item.topicEn), false); cont.appendChild(card); });
        }

        function renderMenuHistory() {
            const list = document.getElementById('menu-history-list');
            if(!list) return;
            list.innerHTML = '';
            state.history.slice(0, 8).forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-slate-50 p-2 rounded-lg text-sm font-bold text-slate-600 truncate cursor-pointer hover:bg-slate-100";
                div.textContent = item.displayTopic;
                div.onclick = () => {
                    playClickSound();
                    document.getElementById('side-menu-overlay').classList.remove('open');
                    loadLesson(item.displayTopic, item.topicEs, item.topicEn, getImageUrl(item.topicEn), false);
                };
                list.appendChild(div);
            });
            const trophyList = document.getElementById('menu-trophies-list');
            if(trophyList) {
                trophyList.innerHTML = '';
                const totalTrophies = state.history.length;
                for(let i=0; i<Math.min(totalTrophies, 8); i++) {
                    const t = document.createElement('div');
                    t.className = "bg-amber-100 rounded-lg aspect-square flex items-center justify-center text-xl shadow-sm border border-amber-200";
                    t.innerText = "üèÜ";
                    trophyList.appendChild(t);
                }
            }
        }

        function renderQuizHistory() {
            const list = document.getElementById('quiz-history-list'); if(!list) return; list.innerHTML = ''; const t = i18n[state.lang];
            if(state.quizHistory.length === 0) { list.innerHTML = `<p>${t.noQuizHistory}</p>`; return; }
            state.quizHistory.forEach(q => { const div = document.createElement('div'); div.className = 'quiz-history-item p-3 mb-2 bg-slate-50 rounded-xl flex justify-between'; div.innerHTML = `<div><p class="font-bold text-slate-700">${q.topic}</p><p class="text-xs text-slate-400">${new Date(q.date).toLocaleDateString()}</p></div><div class="font-bold text-green-600 text-lg">+${q.score}</div>`; list.appendChild(div); });
        }
        
        function renderSearchHistory() {
            const container = document.getElementById('search-history-container'); 
            const tagsDiv = document.getElementById('search-history-tags'); 
            if(!tagsDiv) return; 
            tagsDiv.innerHTML = '';
            
            if(state.searchHistory.length > 0) { 
                container.classList.remove('hidden'); 
                const recent = [...new Set(state.searchHistory)].slice(0, 5); 
                recent.forEach(term => { 
                    const wrapper = document.createElement('span'); 
                    wrapper.className = "search-tag";
                    
                    const text = document.createElement('span');
                    text.textContent = term;
                    text.onclick = () => { playClickSound(); document.getElementById('topic-search').value = term; document.getElementById('search-btn').click(); };
                    
                    const delBtn = document.createElement('span');
                    delBtn.innerHTML = "√ó";
                    delBtn.className = "tag-delete";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        playClickSound();
                        state.searchHistory = state.searchHistory.filter(t => t !== term);
                        localStorage.setItem('searchHist', JSON.stringify(state.searchHistory));
                        renderSearchHistory();
                    };

                    wrapper.appendChild(text);
                    wrapper.appendChild(delBtn);
                    tagsDiv.appendChild(wrapper); 
                }); 
            } else { 
                container.classList.add('hidden'); 
            }
        }

        // LESSON GENERATION WITH AI API FALLBACK
        async function loadLesson(displayTopic, topicEs, topicEn, imgUrl, isMagicMode) {
             const t = i18n[state.lang];
             
             // Limpiar buscador
             document.getElementById('topic-search').value = "";
             
             document.getElementById('main-header').classList.add('hidden'); 
             document.getElementById('main-tabs').classList.add('hidden');
             document.getElementById('discoveryContainer').style.display = 'none'; 
             document.getElementById('lessonDetailContainer').style.display = 'block'; 
             
             document.getElementById('lesson-content-wrapper').classList.add('hidden'); 
             document.getElementById('lesson-error-state').classList.add('hidden'); 
             document.getElementById('lesson-loader').classList.remove('hidden'); 
             window.scrollTo(0,0);
             
             document.getElementById('lesson-title').textContent = displayTopic; 
             document.getElementById('lesson-header-bg').style.backgroundImage = `url('${imgUrl}')`;
             
             // Build the prompt for AI
             const systemPrompt = state.lang === 'es' 
                 ? `Eres un tutor educativo amigable para ni√±os. Explica los temas de manera simple, divertida y educativa. Usa emojis ocasionalmente. Responde siempre en espa√±ol.`
                 : `You are a friendly educational tutor for kids. Explain topics in a simple, fun, and educational way. Use emojis occasionally. Always respond in English.`;
             
             const userPrompt = state.lang === 'es'
                 ? `Crea una lecci√≥n corta y divertida sobre "${displayTopic}" para ni√±os. Incluye:
                    1. Una explicaci√≥n de 3-4 p√°rrafos
                    2. 3 preguntas de opci√≥n m√∫ltiple con 3 opciones cada una
                    
                    Responde en formato JSON as√≠:
                    {
                        "lesson": "texto de la lecci√≥n aqu√≠",
                        "questions": [
                            {"q": "pregunta 1", "options": ["opci√≥n a", "opci√≥n b", "opci√≥n c"], "correct": 0},
                            {"q": "pregunta 2", "options": ["opci√≥n a", "opci√≥n b", "opci√≥n c"], "correct": 1},
                            {"q": "pregunta 3", "options": ["opci√≥n a", "opci√≥n b", "opci√≥n c"], "correct": 2}
                        ]
                    }`
                 : `Create a short and fun lesson about "${displayTopic}" for kids. Include:
                    1. An explanation of 3-4 paragraphs
                    2. 3 multiple choice questions with 3 options each
                    
                    Respond in JSON format like this:
                    {
                        "lesson": "lesson text here",
                        "questions": [
                            {"q": "question 1", "options": ["option a", "option b", "option c"], "correct": 0},
                            {"q": "question 2", "options": ["option a", "option b", "option c"], "correct": 1},
                            {"q": "question 3", "options": ["option a", "option b", "option c"], "correct": 2}
                        ]
                    }`;

             try {
                 // Use the fallback-enabled generateText function
                 const result = await generateText(userPrompt, systemPrompt);
                 
                 let lessonData;
                 
                 if (result.provider === 'fallback') {
                     // Use mock data when all APIs fail
                     lessonData = getMockLessonData(displayTopic);
                 } else {
                     // Try to parse AI response as JSON
                     try {
                         // Extract JSON from response (handle markdown code blocks)
                         let jsonText = result.text;
                         const jsonMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                         if (jsonMatch) {
                             jsonText = jsonMatch[1];
                         } else {
                             // Try to find JSON object in text
                             const objMatch = jsonText.match(/\{[\s\S]*\}/);
                             if (objMatch) {
                                 jsonText = objMatch[0];
                             }
                         }
                         lessonData = JSON.parse(jsonText);
                     } catch (parseError) {
                         console.log('JSON parse error, using text as lesson:', parseError);
                         lessonData = {
                             lesson: result.text,
                             questions: getMockQuestions(displayTopic)
                         };
                     }
                 }
                 
                 renderLessonContent(lessonData);
                 state.currentLesson = { ...lessonData, displayTopic, topicEs, topicEn, imgUrl };
                 state.currentText = lessonData.lesson; // Store for TTS
                 
             } catch (error) {
                 console.log('Lesson generation error:', error);
                 // Use mock data as final fallback - no error shown to user
                 const mockData = getMockLessonData(displayTopic);
                 renderLessonContent(mockData);
                 state.currentLesson = { ...mockData, displayTopic, topicEs, topicEn, imgUrl };
                 state.currentText = mockData.lesson;
             }
        }

        // Mock data when all APIs fail
        function getMockLessonData(displayTopic) {
            const lang = state.lang || 'es';
            if (lang === 'es') {
                return {
                    lesson: `¬°Hola! Hoy vamos a aprender algo incre√≠ble sobre **${displayTopic}**. üåü\n\n¬øSab√≠as que este es un tema fascinante? Los expertos dicen que conocer sobre esto nos ayuda a entender mejor el mundo que nos rodea.\n\nImagina que eres un explorador descubriendo secretos antiguos. Cada cosa nueva que aprendes es como encontrar un tesoro. üèÜ\n\n¬°Sigue explorando para convertirte en un experto! Puedes configurar tus claves de API en el men√∫ de ajustes (‚öôÔ∏è) para obtener lecciones personalizadas.`,
                    questions: getMockQuestions(displayTopic)
                };
            }
            return {
                lesson: `Hello! Today we're going to learn something amazing about **${displayTopic}**. üåü\n\nDid you know this is a fascinating topic? Experts say that learning about this helps us understand the world around us better.\n\nImagine you're an explorer discovering ancient secrets. Every new thing you learn is like finding treasure. üèÜ\n\nKeep exploring to become an expert! You can configure your API keys in the settings menu (‚öôÔ∏è) to get personalized lessons.`,
                questions: getMockQuestions(displayTopic)
            };
        }

        function getMockQuestions(displayTopic) {
            const lang = state.lang || 'es';
            if (lang === 'es') {
                return [
                    {q: `¬øQu√© estamos aprendiendo hoy?`, options: ["Nada importante", displayTopic, "A dormir"], correct: 1},
                    {q: "Aprender cosas nuevas es...", options: ["Aburrido", "¬°Un superpoder!", "Malo"], correct: 1},
                    {q: "¬øQu√© deber√≠amos hacer despu√©s?", options: ["Investigar m√°s", "Rendirse", "Nada"], correct: 0}
                ];
            }
            return [
                {q: `What are we learning today?`, options: ["Nothing important", displayTopic, "To sleep"], correct: 1},
                {q: "Learning new things is...", options: ["Boring", "A superpower!", "Bad"], correct: 1},
                {q: "What should we do next?", options: ["Research more", "Give up", "Nothing"], correct: 0}
            ];
        }

        function renderLessonContent(data) {
            document.getElementById('lesson-loader').classList.add('hidden'); 
            document.getElementById('lesson-content-wrapper').classList.remove('hidden'); 
            document.getElementById('lesson-content').innerHTML = data.lesson;
            
            // Set up Read For Me button with TTS
            document.getElementById('read-for-me-btn').onclick = async () => { 
                playClickSound(); 
                const lessonText = data.lesson;
                await speak(lessonText);
            };
            
            const qList = document.getElementById('lesson-questions-list'); 
            qList.innerHTML = '';
            
            if(data.questions) { 
                data.questions.forEach((item, idx) => { 
                    const qContainer = document.createElement('div'); 
                    qContainer.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"; 
                    
                    // Create question header
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "flex justify-between items-center mb-3";
                    
                    const questionP = document.createElement('p');
                    questionP.className = "font-bold text-lg text-slate-800";
                    questionP.textContent = `‚ùì ${item.q}`;
                    
                    const speakBtn = document.createElement('button');
                    speakBtn.className = "text-blue-400 hover:text-blue-600 text-xl";
                    speakBtn.textContent = "üîä";
                    speakBtn.addEventListener('click', () => speak(item.q));
                    
                    headerDiv.appendChild(questionP);
                    headerDiv.appendChild(speakBtn);
                    qContainer.appendChild(headerDiv);
                    
                    // Create options container
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = "mt-2 space-y-2";
                    
                    item.options.forEach((opt, optIdx) => { 
                        const optionDiv = document.createElement('div');
                        optionDiv.className = "quiz-option mt-2";
                        optionDiv.textContent = opt;
                        optionDiv.addEventListener('click', function() {
                            checkLessonAnswer(this, optIdx === item.correct, opt);
                        });
                        optionsDiv.appendChild(optionDiv);
                    }); 
                    
                    qContainer.appendChild(optionsDiv);
                    qList.appendChild(qContainer); 
                }); 
            }
        }
        
        document.getElementById('generate-button').onclick = () => { if(state.currentLesson) loadLesson(state.currentLesson.displayTopic, state.currentLesson.topicEs, state.currentLesson.topicEn, state.currentLesson.imgUrl, true); };
        
        window.checkLessonAnswer = function(el, isCorrect, text) { const t = i18n[state.lang]; if(el.classList.contains('correct') || el.classList.contains('wrong')) return; if(isCorrect) { el.classList.add('correct'); playCorrectSound(); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); } else { el.classList.add('wrong'); playWrongSound(); } };

        document.getElementById('start-random-quiz').onclick = () => { alert("¬°Pronto disponible con tu Backend!"); };

        // --- INICIALIZACI√ìN ---
        
        function toggleLangIntro() { playClickSound(); state.lang = state.lang==='es'?'en':'es'; localStorage.setItem('appLang', state.lang); updateUI(); }
        
        function startApp() {
             try {
                document.getElementById('global-loader').style.display = 'none';
                
                if (state.userName && state.userName.trim() !== "") {
                    document.getElementById('nameInputScreen').style.display = 'none'; 
                    document.getElementById('app-container').style.display = 'block'; 
                    document.getElementById('app-container').style.paddingTop = '80px'; 
                    document.getElementById('app-container').style.opacity = '1'; 
                    updateUI();
                    const bg = document.getElementById('bg-music');
                    if(bg) { bg.volume = 0.05; bg.play().catch(()=>{}); }
                } else {
                    document.getElementById('nameInputScreen').style.display = 'flex'; 
                    document.getElementById('app-container').style.display = 'none'; 
                    updateUI(); 
                }
            } catch (e) { console.log(e); }
        }
        
        document.getElementById('nameSubmitBtn').onclick = () => { 
            playClickSound();
            const nameInput = document.getElementById('nameInputField').value.trim(); 
            if (nameInput) { 
                state.userName = nameInput.split(' ')[0]; 
                localStorage.setItem('userName', state.userName); 
                startApp(); 
                const bg = document.getElementById('bg-music');
                if(bg) { bg.volume = 0.05; bg.play().catch(()=>{}); }
            } 
        };
        document.getElementById('reset-user-btn').onclick = () => { localStorage.removeItem('userName'); sessionStorage.clear(); location.reload(); };

        document.addEventListener('DOMContentLoaded', () => {
            const langToggleMain = document.getElementById('lang-toggle'); if (langToggleMain) langToggleMain.onclick = toggleLangIntro; 
            const langToggleIntro = document.getElementById('lang-toggle-intro'); if (langToggleIntro) langToggleIntro.onclick = toggleLangIntro;
            
            setTimeout(() => { startApp(); }, 500); 
            
            const switchTab = (active) => {
                document.getElementById('tab-lesson').className = active==='lesson' ? "btn-fun shadow-blue-400 ring-4 ring-blue-50" : "btn-secondary-fun";
                document.getElementById('tab-quiz').className = active==='quiz' ? "btn-fun shadow-blue-400 ring-4 ring-blue-50" : "btn-secondary-fun";
                document.getElementById('lessonView').style.display = active==='lesson' ? 'block' : 'none';
                document.getElementById('quizView').style.display = active==='quiz' ? 'block' : 'none';
                
                if(active === 'quiz') { 
                    document.getElementById('main-header').classList.add('hidden'); 
                    document.getElementById('main-tabs').classList.add('hidden');
                } else if(active === 'lesson') {
                    if(document.getElementById('discoveryContainer').style.display !== 'none') {
                         document.getElementById('main-header').classList.remove('hidden'); 
                         document.getElementById('main-tabs').classList.remove('hidden');
                    }
                }
            };
            document.getElementById('tab-lesson').onclick = () => { playClickSound(); switchTab('lesson'); };
            document.getElementById('tab-quiz').onclick = () => { playClickSound(); switchTab('quiz'); };
            document.getElementById('load-more-btn').onclick = () => { playClickSound(); state.itemsToShow += 9; renderMosaics(null, 'category-mosaics'); };
            document.getElementById('search-btn').onclick = () => { playClickSound(); const v = document.getElementById('topic-search').value; if(v) loadLesson(v, v, v, getImageUrl(v), false); };
            document.getElementById('topic-search').onkeypress = (e) => { if(e.key==='Enter') document.getElementById('search-btn').click(); };
            document.getElementById('back-button').onclick = () => { 
                playClickSound();
                document.getElementById('lessonDetailContainer').style.display = 'none'; document.getElementById('discoveryContainer').style.display = 'block'; 
                document.getElementById('main-header').classList.remove('hidden'); document.getElementById('main-tabs').classList.remove('hidden');
                window.scrollTo(0,0); 
            };
            // ... Resto de eventos de pesta√±as ...
            document.getElementById('subtab-explore').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.remove('hidden'); document.getElementById('section-trophies').classList.add('hidden'); document.getElementById('section-branches').classList.add('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-trophies').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600');
                renderMosaics(null, 'category-mosaics'); 
                document.getElementById('load-more-btn').style.display = 'block';
                document.getElementById('clear-filter-container').classList.add('hidden');
            };
            document.getElementById('subtab-branches').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.add('hidden'); document.getElementById('section-trophies').classList.add('hidden'); document.getElementById('section-branches').classList.remove('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-trophies').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-explore').classList.remove('text-blue-600','border-blue-600');
            };
            document.getElementById('subtab-trophies').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.add('hidden'); document.getElementById('section-trophies').classList.remove('hidden'); document.getElementById('section-branches').classList.add('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-explore').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600'); renderHistory(); 
            };
        });
    </script>
</body>
</html>
