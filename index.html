<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clase M√°gica de Mikhail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ... (MISMOS ESTILOS QUE ANTES, SIN CAMBIOS) ... */
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        body { font-family: 'Quicksand', sans-serif; background: linear-gradient(180deg, #f0f9ff 0%, #cce7ff 100%); min-height: 100vh; color: #334155; overflow-x: hidden; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .fun-font { font-family: 'Fredoka', sans-serif; }
        nav { z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.6); position: sticky; top: 0; }
        .topic-card { background: white; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; height: 220px; border: 4px solid white; z-index: 10; display: flex; flex-direction: column; }
        .topic-image { height: 100%; width: 100%; background-size: cover; background-position: center; pointer-events: none; transition: transform 0.3s; }
        .topic-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0) 100%); padding: 16px; display: flex; flex-direction: column; justify-content: flex-end; height: 70%; pointer-events: auto; cursor: pointer; }
        .topic-btn { background: #2563eb; color: white; border-radius: 999px; padding: 6px 16px; font-size: 0.9rem; font-weight: bold; align-self: flex-start; margin-top: 8px; box-shadow: 0 2px 0 #1e3a8a; pointer-events: none; }
        .fact-card { background: white; border: 2px solid #fbbf24; border-radius: 1rem; padding: 0.8rem; margin-bottom: 1rem; box-shadow: 0 4px 0 #f59e0b; position: relative; z-index: 20; transition: all 0.3s; overflow: hidden; }
        .fact-nav-btn { background: #fef3c7; color: #d97706; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; border: 1px solid #fcd34d; flex-shrink: 0; }
        .fact-nav-btn:active { background: #d97706; color: white; transform: scale(0.9); }
        .btn-fun { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-radius: 1.5rem; padding: 1rem 1.5rem; font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 0 #1e3a8a; transition: transform 0.1s; border: none; cursor: pointer; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; }
        .btn-fun:active { transform: translateY(4px); box-shadow: 0 0 0 #1e3a8a; }
        .btn-fun:disabled { background: #94a3b8; box-shadow: none; cursor: default; transform: none; }
        .btn-secondary-fun { background: white; color: #475569; border: 3px solid #cbd5e1; border-radius: 1.5rem; padding: 0.8rem 1.5rem; font-weight: 700; transition: transform 0.2s; box-shadow: 0 4px 0 #94a3b8; cursor: pointer; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; }
        .btn-secondary-fun:active { transform: translateY(4px); box-shadow: 0 0 0 #94a3b8; }
        .btn-danger-fun { background: #fee2e2; color: #ef4444; border: 2px solid #fecaca; border-radius: 1rem; padding: 0.5rem 1rem; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; box-shadow: 0 3px 0 #fca5a5; }
        .btn-danger-fun:active { transform: translateY(3px); box-shadow: none; }
        .btn-load-more { background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; border: none; border-radius: 2rem; width: 100%; padding: 1rem; font-weight: 700; font-family: 'Fredoka', sans-serif; font-size: 1.2rem; transition: all 0.3s; cursor: pointer; margin-top: 1rem; position: relative; z-index: 20; box-shadow: 0 6px 0 #d14424; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .btn-load-more:active { transform: translateY(4px); box-shadow: 0 2px 0 #d14424; }
        .quiz-option { background: white; border: 2px solid #e2e8f0; padding: 1.2rem; border-radius: 1.2rem; cursor: pointer; transition: background 0.2s; font-weight: 600; color: #475569; font-size: 1.1rem; touch-action: manipulation; }
        .quiz-option:active { border-color: #3b82f6; background: #eff6ff; }
        .quiz-option.correct { background: #dcfce7; border-color: #22c55e; color: #15803d; }
        .quiz-option.wrong { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        #sticky-audio-player { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(200%); width: 95%; max-width: 500px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 24px; padding: 12px 20px; z-index: 2000; box-shadow: 0 10px 40px rgba(37, 99, 235, 0.25); display: flex; align-items: center; justify-content: space-between; border: 2px solid #fff; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #sticky-audio-player.visible { transform: translateX(-50%) translateY(0); }
        #assistant-btn { position: fixed; bottom: 25px; right: 20px; z-index: 3000; width: 75px; height: 75px; background-color: white; background-size: cover; background-position: center; border-radius: 50%; box-shadow: 0 6px 0 #cbd5e1, 0 10px 20px rgba(0,0,0,0.15); cursor: pointer; border: 3px solid #fff; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #assistant-btn:active { transform: scale(0.9); }
        #assistant-btn.move-up { transform: translateY(-110px); }
        .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(4px); }
        .side-menu { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: white; z-index: 5001; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 24px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .side-menu-overlay.open { opacity: 1; visibility: visible; }
        .side-menu-overlay.open .side-menu { transform: translateX(0); }
        .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 4000; display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; backdrop-filter: blur(4px); }
        .chat-overlay.open { opacity: 1; visibility: visible; }
        .chat-box { width: 100%; max-width: 400px; height: 60vh; background: white; border-radius: 32px 32px 0 0; overflow: hidden; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: none; }
        @media (min-width: 768px) { .chat-overlay { align-items: center; padding: 20px; } .chat-box { height: 550px; border-radius: 32px; transform: scale(0.95); border: 5px solid #bfdbfe; } }
        .chat-overlay.open .chat-box { transform: translateY(0); }
        @media (min-width: 768px) { .chat-overlay.open .chat-box { transform: scale(1); } }
        .search-tag { display: inline-flex; align-items: center; background: white; color: #64748b; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; border: 1px solid #e2e8f0; margin-right: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .search-tag:active { background: #eff6ff; color: #3b82f6; border-color: #bfdbfe; }
        .tag-delete { margin-left: 6px; color: #94a3b8; font-weight: bold; padding: 0 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tag-delete:hover { background: #fee2e2; color: #ef4444; }
        .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .inline-speak-btn { background: #dbeafe; color: #2563eb; border-radius: 50%; padding: 8px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px; width: 40px; height: 40px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; top: 4px; }
        .flag-icon { width: 32px; height: 24px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .read-for-me-btn { background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #bae6fd; color: #0284c7; padding: 12px 20px; border-radius: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; cursor: pointer; margin-bottom: 24px; transition: all 0.2s; box-shadow: 0 4px 0 #bae6fd; }
        .read-for-me-btn:active { transform: translateY(2px); box-shadow: none; }
        .read-for-me-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    </style>
</head>
<body class="no-select">
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/1114/1114-preview.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3" preload="auto"></audio>

    <div id="global-loader" class="fixed inset-0" style="background: #f0f9ff; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="text-7xl animate-bounce">üë©‚Äçüè´</div>
        <h2 class="text-2xl font-bold text-blue-600 mt-6 fun-font" data-i18n="preparing">Preparando tu estudio...</h2>
    </div>

    <div id="nameInputScreen" class="fixed inset-0 w-full h-full" style="display: flex; background: #fff; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; z-index: 6000;">
        <div class="absolute top-0 right-0 p-4">
            <button id="lang-toggle-intro" class="flex items-center gap-2 px-3 py-2 rounded-full bg-white border border-slate-200 active:scale-95 cursor-pointer relative z-30" onclick="playClickSound()">
                <img id="lang-flag-img-intro" src="https://flagcdn.com/w40/mx.png" alt="MX" class="flag-icon" style="width: 24px; height: 18px;">
                <span id="lang-text-intro" class="text-sm font-bold text-slate-700">ES</span>
            </button>
        </div>
        <div class="text-9xl mb-6">‚úèÔ∏è</div>
        <h2 id="namePrompt" class="text-4xl font-bold text-slate-800 fun-font mb-4 text-center">¬øCu√°l es tu nombre?</h2>
        <p id="nameSubtitle" class="text-slate-500 text-lg mb-8 text-center max-w-sm">As√≠ podr√© ser tu tutor personal.</p>
        <div class="w-full max-w-xs">
            <input type="text" id="nameInputField" class="w-full p-4 rounded-xl border-4 border-blue-200 focus:border-blue-500 outline-none text-slate-700 font-bold text-xl mb-6 text-center" placeholder="Tu Nombre">
            <button id="nameSubmitBtn" class="btn-fun w-full py-4 text-xl" onclick="playClickSound()">¬°Empezar!</button>
        </div>
    </div>

    <div id="side-menu-overlay" class="side-menu-overlay">
        <div class="side-menu">
            <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold fun-font mb-1">Tu Progreso</h2>
                    <p class="text-blue-100 text-sm">¬°Sigue aprendiendo!</p>
                </div>
                <button onclick="document.getElementById('side-menu-overlay').classList.remove('open'); playClickSound()" class="text-white bg-white/20 rounded-full w-8 h-8 flex items-center justify-center font-bold">‚úï</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto">
                <h3 class="font-bold text-slate-600 mb-2 uppercase text-xs tracking-wider">Lecciones Recientes</h3>
                <div id="menu-history-list" class="space-y-2 mb-6"></div>
                <h3 class="font-bold text-slate-600 mb-2 uppercase text-xs tracking-wider">Tus Trofeos</h3>
                <div id="menu-trophies-list" class="grid grid-cols-4 gap-2"></div>
            </div>
            <div class="p-4 border-t border-slate-100">
                <button id="reset-user-btn" class="w-full py-3 text-red-500 font-bold bg-red-50 rounded-xl active:bg-red-100" onclick="playClickSound()">Cerrar Sesi√≥n</button>
            </div>
        </div>
        <div class="absolute inset-0 z-40" onclick="document.getElementById('side-menu-overlay').classList.remove('open')"></div>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500 relative z-10" style="display:none;">
        <nav class="px-4 py-3 shadow-sm fixed top-0 left-0 right-0 max-w-6xl mx-auto" style="max-width: 100%; backdrop-filter: none; background: #f0f9ff;">
             <div class="max-w-6xl mx-auto flex items-center justify-between">
                <button id="menu-btn" class="flex items-center gap-3 active:scale-95 transition cursor-pointer" onclick="playClickSound()">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/20 text-white font-bold transform -rotate-3 border-2 border-white">M</div>
                    <div class="text-left">
                        <h1 id="app-title-display" class="text-xl font-bold text-slate-800 leading-tight fun-font" data-i18n="appTitle">Mundo [NAME]</h1>
                        <div class="flex items-center gap-1.5 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100 inline-block mt-0.5">
                            <span class="text-amber-500 text-xs">‚≠ê</span>
                            <p class="text-[10px] font-bold text-amber-700" id="points-display">0 Puntos</p>
                        </div>
                    </div>
                </button>
                <div class="flex gap-3 items-center">
                    <button id="music-btn" class="text-xl bg-white p-2 rounded-full border border-slate-200 shadow-sm active:bg-blue-50 transition cursor-pointer" onclick="toggleMusic()">üéµ</button>
                    <button id="home-btn" class="text-2xl bg-white p-2 rounded-full border border-slate-200 shadow-sm active:bg-blue-50 transition cursor-pointer" onclick="playClickSound()">üè†</button>
                    <button id="lang-toggle" class="flex items-center gap-2 px-3 py-2 rounded-full bg-white border border-slate-200 active:scale-95 cursor-pointer relative z-30" onclick="playClickSound()">
                        <img id="lang-flag-img" src="https://flagcdn.com/w40/mx.png" alt="MX" class="flag-icon" style="width: 24px; height: 18px;">
                        <span id="lang-text" class="text-sm font-bold text-slate-700">ES</span>
                    </button>
                </div>
            </div>
        </nav>
        
        <div id="main-header" class="text-center mb-8 mt-24 transition-all duration-300">
            <h2 class="text-3xl md:text-6xl font-bold text-slate-800 fun-font mb-2 tracking-tight" id="welcome-greeting"></h2>
            <p class="text-slate-500 font-medium text-lg md:text-2xl" data-i18n="subtitle">¬øQu√© quieres descubrir hoy?</p>
        </div>

        <div id="main-tabs" class="flex justify-center mb-10 gap-4 relative z-30 transition-all duration-300">
            <button id="tab-lesson" data-view="lessonView" class="btn-fun shadow-blue-400 ring-4 ring-blue-50" onclick="playClickSound()">
                <span data-i18n="tabLessons">üìö Lecciones</span>
            </button>
            <button id="tab-quiz" data-view="quizView" class="btn-secondary-fun" onclick="playClickSound()">
                <span data-i18n="tabQuizzes">üß† Pruebas</span>
            </button>
        </div>

        <div id="lessonView" class="view block">
            <div id="discoveryContainer">
                <div class="max-w-3xl mx-auto relative z-20 mb-6">
                    <div class="fact-card">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl bg-yellow-100 p-2 rounded-lg flex-shrink-0">üí°</div>
                            <div class="flex-grow min-w-0">
                                <h3 class="font-bold text-amber-800 text-sm mb-0 fun-font flex justify-between items-center">
                                    <span data-i18n="factTitle">Curiosidad:</span>
                                    <span class="text-[10px] bg-amber-100 px-2 py-0.5 rounded text-amber-600 whitespace-nowrap" id="fact-counter">1/20</span>
                                </h3>
                                <div class="min-h-[24px] flex items-center">
                                    <p id="daily-fact" class="text-amber-900 font-medium text-sm animate-fade-in leading-snug line-clamp-2" data-i18n="loading">Cargando...</p>
                                </div>
                            </div>
                            <button class="ml-2 text-amber-500 hover:text-amber-700 text-lg flex-shrink-0 p-2" onclick="speak(document.getElementById('daily-fact').innerText)">üîä</button>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-amber-100">
                             <button id="prev-fact" class="fact-nav-btn" onclick="playClickSound()">‚¨ÖÔ∏è</button>
                             <button id="next-fact" class="fact-nav-btn" onclick="playClickSound()">‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>

                <div class="mb-6 max-w-3xl mx-auto relative z-30">
                    <div class="relative group transform transition hover:-translate-y-1">
                        <input type="text" id="topic-search" class="w-full p-4 pl-16 pr-16 rounded-full border-4 border-white shadow-xl shadow-blue-100 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 outline-none text-slate-700 font-bold text-base sm:text-xl bg-white transition" placeholder="‚ú® Busca aqu√≠... (ej: Dinosaurios)">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl opacity-40">üîç</span>
                        <div id="search-mic-container" class="absolute right-20 top-0 bottom-0 flex items-center justify-center w-12 z-50">
                            <button id="search-mic-btn" type="button" class="text-2xl text-slate-400 hover:text-blue-500 active:text-red-500 transition cursor-pointer w-full h-full flex items-center justify-center active:scale-125">üé§</button>
                        </div>
                        <button id="search-btn" class="absolute right-2 top-2 bottom-2 bg-blue-600 text-white px-6 rounded-full font-bold active:bg-blue-700 shadow-md transition text-sm sm:text-lg cursor-pointer z-40" data-i18n="go" onclick="playClickSound()">Ir</button>
                    </div>
                    <div id="search-history-container" class="mt-4 px-2 hidden">
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2" data-i18n="recent">Recientes:</p>
                        <div id="search-history-tags"></div>
                    </div>
                </div>

                <div class="flex items-center justify-center mb-8 gap-3 sm:gap-6 relative z-30 overflow-x-auto px-2 pb-2 no-scrollbar">
                     <button id="subtab-explore" class="text-blue-600 font-bold border-b-4 border-blue-600 pb-2 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üöÄ <span data-i18n="explore">Explorar</span></button>
                     <button id="subtab-branches" class="text-slate-400 font-bold border-b-4 border-transparent pb-2 active:text-slate-600 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üåø Ramas</button>
                    <button id="subtab-trophies" class="text-slate-400 font-bold border-b-4 border-transparent pb-2 active:text-slate-600 transition text-sm sm:text-lg px-2 cursor-pointer whitespace-nowrap" onclick="playClickSound()">üèÜ <span data-i18n="trophies">Trofeos</span></button>
                </div>

                <div id="section-explore">
                    <div id="clear-filter-container" class="hidden mb-4 text-center">
                        <button id="clear-filter-btn" class="text-blue-600 font-bold text-sm bg-blue-50 px-4 py-2 rounded-full hover:bg-blue-100 transition shadow-sm border border-blue-100" onclick="playClickSound()">
                            ‚¨Ö Volver a todas las Ramas
                        </button>
                    </div>
                    <div id="category-mosaics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 relative z-10"></div>
                    <button id="load-more-btn" class="btn-load-more text-lg" data-i18n="loadMore" onclick="playClickSound()">üåü ¬°Generar m√°s! üåü</button>
                </div>

                <div id="section-branches" class="hidden">
                    <div class="text-center mb-4">
                        <p class="text-slate-500 text-sm">Selecciona un tema favorito:</p>
                    </div>
                    <div id="branches-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8"></div>
                </div>

                <div id="section-trophies" class="hidden">
                     <div id="learned-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 relative z-10"></div>
                </div>
            </div>

            <div id="lessonDetailContainer" class="hidden max-w-4xl mx-auto pb-24 relative z-20 mt-2">
                <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden relative border border-slate-100">
                    <div id="lesson-header-bg" class="h-64 sm:h-96 bg-slate-100 relative w-full group">
                        <div class="absolute top-4 left-4 z-30">
                            <button id="back-button" class="flex items-center text-slate-600 active:text-blue-600 transition font-bold text-base bg-white/90 backdrop-blur-md px-5 py-2 rounded-full shadow-lg border-2 border-white group cursor-pointer hover:bg-blue-50" onclick="playClickSound()">
                                <span class="group-active:-translate-x-1 transition text-xl mr-2">‚¨ÖÔ∏è</span> <span data-i18n="back">Volver</span>
                            </button>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-6 sm:p-10 w-full z-10">
                            <h2 id="lesson-title" class="text-4xl sm:text-6xl text-white font-bold fun-font drop-shadow-xl mb-2 leading-tight">...</h2>
                        </div>
                    </div>
                    
                    <div class="p-6 sm:p-14">
                        <div id="lesson-loader" class="hidden text-center py-24">
                            <div class="text-8xl animate-bounce mb-8">‚ú®</div>
                            <p class="text-slate-700 font-bold text-2xl fun-font animate-pulse" data-i18n="preparingLesson">Robi est√° preparando la clase...</p>
                        </div>

                        <div id="lesson-error-state" class="hidden text-center py-12">
                             <div class="text-6xl mb-4">üôà</div>
                             <h3 class="text-xl font-bold text-slate-700 mb-2" data-i18n="errorTitle">¬°Ups! Se nos cay√≥ la tiza</h3>
                             <button id="retry-lesson-btn" class="btn-fun" data-i18n="retry" onclick="playClickSound()">Intentar de nuevo</button>
                        </div>

                        <div id="lesson-content-wrapper" class="hidden animate-fade-in">
                            <button id="read-for-me-btn" class="read-for-me-btn" onclick="playClickSound()">
                                <span class="text-2xl">üó£Ô∏è</span> <span class="text-lg">L√©elo por m√≠</span>
                            </button>

                            <div class="bg-blue-50/50 p-6 sm:p-10 rounded-[2rem] mb-10 border-2 border-blue-100">
                                <div class="prose max-w-none text-slate-700 leading-loose text-xl sm:text-2xl font-medium">
                                    <div id="lesson-content" class="inline">...</div>
                                </div>
                            </div>
                            <div id="lesson-questions-section" class="mb-10">
                                <h3 class="text-xl sm:text-2xl font-bold text-slate-800 fun-font mb-6 flex items-center gap-2"><span>üß©</span> <span data-i18n="letsPractice">¬°Practiquemos!</span></h3>
                                <div id="lesson-questions-list" class="space-y-6"></div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                                 <button id="generate-button" class="flex-1 btn-secondary-fun py-4 text-lg flex items-center justify-center gap-2" onclick="playClickSound()">‚ú® <span data-i18n="regenerate">Versi√≥n m√°s larga</span></button>
                                <button id="complete-button" class="flex-[2] btn-fun py-4 text-lg shadow-lg shadow-blue-500/30 text-white" onclick="playClickSound()">‚úÖ <span data-i18n="complete">¬°Termin√©!</span> (+50)</button>
                            </div>
                            <div class="mt-12 pt-8 border-t-4 border-dashed border-slate-100">
                                <div id="show-more-btn" class="text-center mb-6"><h3 class="text-xl font-bold text-slate-400" data-i18n="moreInfo">üëá Sigue explorando</h3></div>
                                <div id="more-info-section" class="flex flex-wrap justify-center gap-3 relative z-20">
                                    <div id="subcategories-list" class="flex flex-wrap justify-center gap-3 w-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="quizView" class="view hidden max-w-4xl mx-auto pb-20 relative z-20">
            <div id="quiz-placeholder" class="bg-white p-8 sm:p-12 rounded-[2rem] shadow-xl border border-slate-100 text-center py-20 sm:py-32">
                <div class="text-8xl sm:text-9xl mb-8">üß†</div>
                <h2 class="text-4xl sm:text-5xl font-bold text-slate-800 mb-4 fun-font" data-i18n="quizZone">Zona de Pruebas</h2>
                <p class="text-slate-500 text-lg sm:text-2xl max-w-lg mx-auto leading-relaxed mb-8" data-i18n="quizDesc">¬°Demuestra lo que sabes con retos sorpresa!</p>
                <div class="grid md:grid-cols-2 gap-8 text-left">
                    <div class="mb-6 md:mb-0">
                         <h3 class="font-bold text-slate-700 mb-4 text-lg" data-i18n="quizHistory">Tu Historial de Pruebas:</h3>
                         <div id="quiz-history-list" class="max-h-60 overflow-y-auto pr-2 text-sm text-slate-500"><p data-i18n="noQuizHistory">A√∫n no has hecho ninguna prueba.</p></div>
                    </div>
                    <div class="flex flex-col justify-center gap-4">
                        <button id="start-random-quiz" class="btn-fun text-lg w-full py-4" data-i18n="startQuiz" onclick="playClickSound()">üöÄ Iniciar Prueba Sorpresa</button>
                    </div>
                </div>
            </div>
            
            <div id="quiz-container" class="hidden">
                <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-100 p-6 sm:p-14">
                    <div class="flex justify-between items-center mb-8 border-b-2 border-slate-100 pb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 fun-font" id="quiz-topic-title">Cargando...</h2>
                        <div class="flex gap-2 items-center">
                            <button onclick="exitQuiz(); playClickSound()" class="btn-danger-fun" data-i18n="exit">Salir</button>
                        </div>
                    </div>
                    <div id="quiz-questions-list" class="space-y-6"></div>
                    <button id="finish-quiz-btn" class="hidden mt-8 w-full btn-fun text-lg py-4" data-i18n="saveResult" onclick="playClickSound()">Guardar Resultado</button>
                    <div id="quiz-result" class="hidden mt-8 p-6 bg-green-50 rounded-[2rem] border-2 border-green-200 text-center animate-fade-in">
                        <p class="text-3xl sm:text-4xl font-bold text-green-600 fun-font mb-2" data-i18n="quizFinished">¬°Prueba Finalizada! üéâ</p>
                        <p class="text-green-700 font-bold text-xl" id="quiz-score-text">+30 Puntos</p>
                        <button onclick="exitQuiz(); playClickSound()" class="mt-6 btn-secondary-fun" data-i18n="backQuiz">Volver</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AUDIO PLAYER -->
    <div id="sticky-audio-player">
        <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-full flex items-center justify-center text-white text-2xl shadow-lg border-4 border-white animate-pulse flex-shrink-0">üë©‚Äçüè´</div>
        <div class="flex-grow mx-4 overflow-hidden">
            <p class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-0.5" data-i18n="profGemini">PROFE AI</p>
            <p class="text-sm font-bold text-slate-800 truncate" id="player-status" data-i18n="loadingVoice">Cargando voz...</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="player-play-pause" class="w-12 h-12 rounded-full bg-slate-900 text-white font-bold text-xl active:bg-slate-700 shadow-md transition-all flex items-center justify-center cursor-pointer" onclick="playClickSound()">‚è∏</button>
            <button id="player-close" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 active:bg-red-100 active:text-red-500 font-bold text-sm flex items-center justify-center transition-colors cursor-pointer" onclick="playClickSound()">‚úï</button>
        </div>
    </div>

    <!-- MUSICA DE FONDO (URL ESTABLE DE ARCHIVO MP3) -->
    <audio id="bg-music" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <button id="assistant-btn" onclick="playClickSound()"></button>

    <div class="chat-overlay" id="chat-overlay">
        <div class="chat-box">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div id="chat-header-icon" class="w-10 h-10 bg-white rounded-full bg-cover bg-center border-2 border-white"></div>
                    <div>
                        <h3 class="font-bold text-lg fun-font">Robi</h3>
                        <div class="flex items-center gap-2">
                            <p class="text-[10px] text-blue-200 font-medium" data-i18n="personalTutor">Tu Profe Personal</p>
                            <button class="bg-blue-500 active:bg-blue-400 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider" title="Historial Guardado" data-i18n="historyBtn">üìú Historial</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="minimize-chat" class="text-white/70 active:text-white active:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold mb-2 transition cursor-pointer" onclick="playClickSound()">_</button>
                    <button id="close-chat" class="text-white/70 active:text-white active:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center text-2xl transition cursor-pointer" onclick="playClickSound()">‚úï</button>
                </div>
            </div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 bg-slate-50 text-base"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2 items-center flex-shrink-0 pb-6 md:pb-3">
                <button id="voice-chat-btn" class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 active:bg-blue-600 active:text-white transition flex items-center justify-center flex-shrink-0 text-xl shadow-sm border-2 border-transparent cursor-pointer">üé§</button>
                <input type="text" id="chat-input" class="flex-grow bg-slate-100 rounded-full px-4 py-2 outline-none focus:ring-4 focus:ring-blue-100 text-base h-12 text-slate-700 placeholder-slate-400" placeholder="Escribe tu duda...">
                <button id="send-chat" class="bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg active:bg-blue-700 flex items-center justify-center flex-shrink-0 text-xl transform active:scale-95 transition cursor-pointer" onclick="playClickSound()">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        // APIS - AQUI ES DONDE OCURRE LA MAGIA
        // IMPORTANTE: EL PROXY ES SOLO PARA DEMOSTRACI√ìN. EN PRODUCCION USA SERVERLESS
        
        // ============================================
        // API CONFIGURATION
        // ============================================
        const API_CONFIG = {
            openai: {
                key: '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',
                textEndpoint: 'https://api.openai.com/v1/chat/completions',
                imageEndpoint: 'https://api.openai.com/v1/images/generations',
                ttsEndpoint: 'https://api.openai.com/v1/audio/speech'
            },
            gemini: {
                key: 'AIzaSyBg-ayQwoIDEt0lpPs-MDW_QT_Ck_Xs_ss',
                textEndpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            },
            grok: {
                key: 'xai-mIqGxlPmsdVc6U1hJWbW7IUfpWIuwPxTOUlRQ0dEvQpXatIqRksxM3TUnGcFCPRwRbcxQ5Id7EoaqHbf',
                textEndpoint: 'https://api.x.ai/v1/chat/completions'
            },
            murf: {
                key: 'ap2_80cff77b-d30b-4070-b68a-5b83755ee202',
                ttsEndpoint: 'https://api.murf.ai/v1/speech/generate'
            }
        };

        // Voice settings - Female voices for Spanish (Mexico) and English (United States)
        const VOICE_CONFIG = {
            es: {
                openai: 'nova', // Female voice in OpenAI TTS
                murf: 'es-MX-DaliaNeural' // Female Mexican Spanish voice
            },
            en: {
                openai: 'nova', // Female voice in OpenAI TTS
                murf: 'en-US-JennyNeural' // Female US English voice
            }
        };

        // ============================================
        // AI GENERATION SERVICE WITH FALLBACK
        // ============================================
        
        /**
         * Generate text using AI with fallback flow: OpenAI ‚Üí Gemini ‚Üí Grok
         * @param {string} prompt - The prompt for text generation
         * @param {string} lang - Language code ('es' or 'en')
         * @returns {Promise<string>} - Generated text
         */
        async function generateText(prompt, lang = 'es') {
            const systemPrompt = lang === 'es' 
                ? 'Eres un tutor amigable para ni√±os. Responde de forma clara, divertida y educativa en espa√±ol de M√©xico.'
                : 'You are a friendly tutor for children. Respond clearly, fun, and educational in US English.';
            
            // Priority 1: OpenAI (ChatGPT)
            try {
                const response = await fetch(API_CONFIG.openai.textEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.choices[0].message.content;
                }
            } catch (error) {
                // Silently continue to next fallback
            }
            
            // Priority 2: Gemini
            try {
                const response = await fetch(`${API_CONFIG.gemini.textEndpoint}?key=${API_CONFIG.gemini.key}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `${systemPrompt}\n\n${prompt}`
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 1000,
                            temperature: 0.7
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }
            } catch (error) {
                // Silently continue to next fallback
            }
            
            // Priority 3: Grok (xAI)
            try {
                const response = await fetch(API_CONFIG.grok.textEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.grok.key}`
                    },
                    body: JSON.stringify({
                        model: 'grok-beta',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.choices[0].message.content;
                }
            } catch (error) {
                // All services failed
            }
            
            // Return a friendly fallback message if all APIs fail
            return lang === 'es' 
                ? '¬°Ups! No pude generar la informaci√≥n en este momento. Por favor, intenta de nuevo m√°s tarde.'
                : 'Oops! I could not generate the information right now. Please try again later.';
        }

        /**
         * Generate image using AI with fallback flow: OpenAI DALL-E ‚Üí Pollinations
         * @param {string} prompt - The prompt for image generation
         * @returns {Promise<string>} - Image URL
         */
        async function generateImage(prompt) {
            // Priority 1: OpenAI DALL-E
            try {
                const response = await fetch(API_CONFIG.openai.imageEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: 'dall-e-3',
                        prompt: `A colorful, child-friendly educational illustration of: ${prompt}`,
                        n: 1,
                        size: '1024x1024',
                        quality: 'standard'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.data[0].url;
                }
            } catch (error) {
                // Silently continue to fallback
            }
            
            // Fallback: Pollinations (free image generation)
            return `https://image.pollinations.ai/prompt/${encodeURIComponent(`illustration of ${prompt} vector flat colorful`)}?width=600&height=400&nologo=true`;
        }

        /**
         * Generate voice/speech using AI with fallback flow: OpenAI TTS ‚Üí Murf
         * @param {string} text - The text to convert to speech
         * @param {string} lang - Language code ('es' or 'en')
         * @returns {Promise<Blob|null>} - Audio blob or null if failed
         */
        async function generateVoice(text, lang = 'es') {
            const cleanText = stripEmojis(text);
            
            // Priority 1: OpenAI TTS
            try {
                const response = await fetch(API_CONFIG.openai.ttsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: 'tts-1',
                        input: cleanText,
                        voice: VOICE_CONFIG[lang].openai, // Female voice (nova)
                        response_format: 'mp3'
                    })
                });
                
                if (response.ok) {
                    return await response.blob();
                }
            } catch (error) {
                // Silently continue to fallback
            }
            
            // Priority 2: Murf AI
            try {
                const response = await fetch(API_CONFIG.murf.ttsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': API_CONFIG.murf.key
                    },
                    body: JSON.stringify({
                        text: cleanText,
                        voiceId: VOICE_CONFIG[lang].murf,
                        format: 'MP3',
                        sampleRate: 24000
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.audioFile) {
                        // Murf returns a URL, fetch the audio
                        const audioResponse = await fetch(data.audioFile);
                        if (audioResponse.ok) {
                            return await audioResponse.blob();
                        }
                    }
                }
            } catch (error) {
                // Murf failed
            }
            
            // If all TTS APIs fail, return null (will use browser's native TTS as last resort)
            return null;
        }

        /**
         * Speak text using AI voice or native browser TTS as fallback
         * @param {string} text - The text to speak
         */
        async function speak(text) {
            if (!text) return;
            
            const lang = state.lang;
            const playerEl = document.getElementById('sticky-audio-player');
            const statusEl = document.getElementById('player-status');
            const playPauseBtn = document.getElementById('player-play-pause');
            
            // Show audio player
            playerEl.classList.add('visible');
            statusEl.textContent = lang === 'es' ? 'Cargando voz...' : 'Loading voice...';
            
            try {
                // Try AI voice generation
                const audioBlob = await generateVoice(text, lang);
                
                if (audioBlob) {
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    state.audioSource = audio;
                    state.isPlaying = true;
                    state.currentText = text;
                    
                    statusEl.textContent = lang === 'es' ? 'Reproduciendo...' : 'Playing...';
                    playPauseBtn.textContent = '‚è∏';
                    
                    audio.play();
                    
                    audio.onended = () => {
                        state.isPlaying = false;
                        playPauseBtn.textContent = '‚ñ∂';
                        statusEl.textContent = lang === 'es' ? 'Finalizado' : 'Finished';
                        setTimeout(() => playerEl.classList.remove('visible'), 2000);
                    };
                    
                    return;
                }
            } catch (error) {
                // Fall through to native TTS
            }
            
            // Fallback: Native browser TTS
            if ('speechSynthesis' in window) {
                statusEl.textContent = lang === 'es' ? 'Voz b√°sica...' : 'Basic voice...';
                
                const utterance = new SpeechSynthesisUtterance(stripEmojis(text));
                utterance.lang = lang === 'es' ? 'es-MX' : 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                
                // Try to find a female voice
                const voices = speechSynthesis.getVoices();
                const femaleVoice = voices.find(v => 
                    v.lang.startsWith(lang === 'es' ? 'es' : 'en') && 
                    (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('zira') || v.name.toLowerCase().includes('sabina'))
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                utterance.onend = () => {
                    state.isPlaying = false;
                    playPauseBtn.textContent = '‚ñ∂';
                    statusEl.textContent = lang === 'es' ? 'Finalizado' : 'Finished';
                    setTimeout(() => playerEl.classList.remove('visible'), 2000);
                };
                
                state.isPlaying = true;
                playPauseBtn.textContent = '‚è∏';
                speechSynthesis.speak(utterance);
            } else {
                statusEl.textContent = lang === 'es' ? 'Sin soporte de voz' : 'No voice support';
                setTimeout(() => playerEl.classList.remove('visible'), 2000);
            }
        }
        
        // Make speak function available globally for onclick handlers
        window.speak = speak;

        /**
         * Generate lesson content using AI
         * @param {string} topic - The lesson topic
         * @param {string} lang - Language code
         * @returns {Promise<Object>} - Lesson data with content, questions, and related topics
         */
        async function generateLessonContent(topic, lang = 'es') {
            const prompt = lang === 'es'
                ? `Crea una lecci√≥n educativa para ni√±os sobre "${topic}". 
                   Incluye:
                   1. Una explicaci√≥n clara y divertida (3-4 p√°rrafos)
                   2. 3 preguntas de opci√≥n m√∫ltiple con sus respuestas
                   3. 3 temas relacionados para explorar
                   
                   Formato de respuesta JSON:
                   {
                       "lesson": "contenido de la lecci√≥n aqu√≠",
                       "questions": [
                           {"q": "pregunta", "options": ["opci√≥n1", "opci√≥n2", "opci√≥n3"], "correct": 0}
                       ],
                       "related": ["tema1", "tema2", "tema3"]
                   }`
                : `Create an educational lesson for children about "${topic}".
                   Include:
                   1. A clear and fun explanation (3-4 paragraphs)
                   2. 3 multiple choice questions with answers
                   3. 3 related topics to explore
                   
                   Response format JSON:
                   {
                       "lesson": "lesson content here",
                       "questions": [
                           {"q": "question", "options": ["option1", "option2", "option3"], "correct": 0}
                       ],
                       "related": ["topic1", "topic2", "topic3"]
                   }`;
            
            try {
                const response = await generateText(prompt, lang);
                
                // Try to parse JSON from response
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (error) {
                // Failed to generate or parse
            }
            
            // Return default content if generation fails
            return {
                lesson: lang === 'es' 
                    ? `¬°Hola! Hoy vamos a aprender algo incre√≠ble sobre **${topic}**. Este es un tema fascinante que te ayudar√° a entender mejor el mundo. ¬°Sigue explorando para convertirte en un experto!`
                    : `Hello! Today we're going to learn something amazing about **${topic}**. This is a fascinating topic that will help you understand the world better. Keep exploring to become an expert!`,
                questions: [
                    {
                        q: lang === 'es' ? `¬øQu√© estamos aprendiendo hoy?` : `What are we learning today?`,
                        options: lang === 'es' ? ["Nada", topic, "A dormir"] : ["Nothing", topic, "To sleep"],
                        correct: 1
                    }
                ],
                related: lang === 'es' ? ["Ciencia", "Historia", "Arte"] : ["Science", "History", "Art"]
            };
        }

        /**
         * Generate chat response using AI
         * @param {string} message - User message
         * @param {string} lang - Language code
         * @returns {Promise<string>} - AI response
         */
        async function generateChatResponse(message, lang = 'es') {
            const contextPrompt = lang === 'es'
                ? `El usuario pregunta: "${message}". Responde de forma amigable, educativa y apropiada para ni√±os.`
                : `The user asks: "${message}". Respond in a friendly, educational, and child-appropriate way.`;
            
            return await generateText(contextPrompt, lang);
        }

        const robiIconUrl = "https://image.pollinations.ai/prompt/cute%203d%20avatar%20young%20female%20teacher%20low%20ponytail%20black%20hair%20black%20glasses%20friendly%20icon%20soft%20lighting?width=150&height=150&nologo=true";

        const BRANCHES = [
            { name: "Ciencia", icon: "üî¨" }, { name: "Historia", icon: "üè∫" }, { name: "Espacio", icon: "üöÄ" },
            { name: "Arte", icon: "üé®" }, { name: "Animales", icon: "ü¶Å" }, { name: "Tecnolog√≠a", icon: "üíª" },
            { name: "Naturaleza", icon: "üå≥" }, { name: "M√∫sica", icon: "üéµ" }, { name: "Geograf√≠a", icon: "üåç" },
            { name: "Deportes", icon: "‚öΩ" }, { name: "Matem√°ticas", icon: "‚ûó" }, { name: "Literatura", icon: "üìö" },
            { name: "Cuerpo", icon: "ü¶¥" }, { name: "Oc√©anos", icon: "üê≥" }, { name: "Profesiones", icon: "üë©‚Äçüöí" },
            { name: "Veh√≠culos", icon: "üöó" }, { name: "Comida", icon: "üçï" }, { name: "Inventos", icon: "üí°" }
        ];

        // SUBTEMAS DEFINIDOS PARA CADA RAMA (Filtrado Inteligente)
        const BRANCH_TOPICS = {
            "Ciencia": ["Volcanes", "Electricidad", "Imanes", "Microscopios", "Qu√≠mica", "F√≠sica", "El Clima", "Arco√≠ris", "√Åtomos"],
            "Historia": ["Egipto", "Castillos", "Vikingos", "Romanos", "Mayas", "Griegos", "Caballeros", "Pir√°mides", "Reyes"],
            "Espacio": ["Planetas", "La Luna", "El Sol", "Estrellas", "Agujeros Negros", "Cohetes", "Astronautas", "Galaxias", "Cometas"],
            "Arte": ["Pintura", "Leonardo da Vinci", "Colores", "Museos", "Fotograf√≠a", "Cine", "Dibujos", "Teatro", "Escultura"],
            "Animales": ["Dinosaurios", "Tiburones", "Insectos", "Mam√≠feros", "Aves", "Reptiles", "Osos Polares", "Leones", "Mariposas"],
            "Tecnolog√≠a": ["Robots", "Trenes", "Aviones", "Computadoras", "Internet", "Videojuegos", "Coches", "IA", "Tel√©fonos"],
            "Naturaleza": ["Lluvia", "Bosques", "Monta√±as", "R√≠os", "Desiertos", "Flores", "Reciclaje", "Arboles", "Plantas"],
            "M√∫sica": ["Instrumentos", "Mozart", "Beethoven", "Ritmo", "Orquesta", "Canciones", "√ìpera", "Rock", "Piano"],
            "Geograf√≠a": ["Mapas", "Banderas", "Capitales", "Continentes", "Oc√©anos", "Volcanes", "Ciudades", "Selvas", "Polos"],
            "Deportes": ["F√∫tbol", "Baloncesto", "Nataci√≥n", "Olimpiadas", "Tenis", "Gimnasia", "Karate", "B√©isbol", "Carreras"],
            "Matem√°ticas": ["Sumas", "Restas", "Formas", "N√∫meros", "Medidas", "Reloj", "Dinero", "Fracciones", "Geometr√≠a"],
            "Literatura": ["Cuentos", "Poemas", "F√°bulas", "Don Quijote", "Harry Potter", "Leyendas", "Mitos", "Libros", "Escritores"],
            "Cuerpo": ["Cerebro", "Coraz√≥n", "Huesos", "M√∫sculos", "Sentidos", "Dientes", "Digesti√≥n", "ADN", "C√©lulas"],
            "Oc√©anos": ["Ballenas", "Corales", "Submarinos", "Playas", "Olas", "Medusas", "Pulpos", "Barcos", "Icebergs"],
            "Profesiones": ["Bomberos", "M√©dicos", "Polic√≠as", "Maestros", "Cient√≠ficos", "Artistas", "Granjeros", "Pilotos", "Chefs"],
            "Veh√≠culos": ["Coches", "Camiones", "Barcos", "Aviones", "Helic√≥pteros", "Bicicletas", "Motos", "Autobuses", "Tractores"],
            "Comida": ["Frutas", "Verduras", "Pan", "Chocolate", "Pizza", "Vitaminas", "Cocina", "Postres", "Desayuno"],
            "Inventos": ["Rueda", "Bombilla", "Tel√©fono", "Imprenta", "Internet", "Br√∫jula", "Reloj", "C√°mara", "Papel"]
        };

        const STATIC_TOPICS_ES = ["Los Planetas", "Dinosaurios", "Volcanes", "El Oc√©ano", "El Cuerpo Humano", "Antiguo Egipto", "Los Robots", "La Electricidad", "Animales Polares", "La Lluvia", "Las Abejas", "El Espacio", "Los Castillos", "Las Pir√°mides", "Los Tiburones", "La Fotos√≠ntesis", "La Gravedad", "Los Trenes", "Los Aviones", "Los Bosques"];
        const STATIC_TOPICS_EN = ["The Planets", "Dinosaurs", "Volcanoes", "The Ocean", "Human Body", "Ancient Egypt", "Robots", "Electricity", "Polar Animals", "Rain", "Bees", "Space", "Castles", "Pyramids", "Sharks", "Photosynthesis", "Gravity", "Trains", "Airplanes", "Forests"];
        const BASE_FACTS = [ { es: "Las abejas bailan para decir d√≥nde est√°n las flores.", en: "Bees dance to tell where flowers are." }, { es: "El coraz√≥n de un camar√≥n est√° en su cabeza.", en: "A shrimp's heart is in its head." }, { es: "Los delfines duermen con un ojo abierto.", en: "Dolphins sleep with one eye open." }, { es: "Venus es el planeta m√°s caliente del sistema solar.", en: "Venus is the hottest planet in the solar system." }, { es: "Los pulpos tienen 3 corazones.", en: "Octopuses have 3 hearts." } ];

        const state = { lang: localStorage.getItem('appLang') || 'es', userName: localStorage.getItem('userName') || null, points: 0, history: [], quizHistory: [], currentLesson: null, audioCache: new Map(), audioSource: null, isPlaying: false, currentText: "", itemsToShow: 9, isVoiceActive: false, isNative: false, currentFacts: [], currentFactIndex: 0, searchHistory: [], chatHistory: [], currentBranch: null };

        const i18n = {
            es: { preparing: "Preparando...", appTitle: "Mundo [NAME]", welcome: "¬°Hola, [NAME]! üëã", subtitle: "¬øQu√© quieres descubrir hoy?", tabLessons: "üìö Lecciones", tabQuizzes: "üß† Pruebas", factTitle: "Curiosidad:", loading: "Cargando...", go: "Ir", recent: "Recientes:", explore: "Explorar", trophies: "Trofeos", loadMore: "üåü ¬°Generar m√°s! üåü", back: "Volver", preparingLesson: "Robi est√° preparando la clase...", errorTitle: "¬°Ups!", errorDesc: "Robi tuvo un problema.", retry: "Reintentar", letsPractice: "¬°Practiquemos!", regenerate: "Versi√≥n m√°s larga", complete: "¬°Termin√©!", moreInfo: "üëá Sigue explorando", quizZone: "Zona de Pruebas", quizDesc: "¬°Demuestra lo que sabes!", quizHistory: "Tu Historial:", noQuizHistory: "Sin pruebas.", startQuiz: "üöÄ Iniciar Prueba", goToStudy: "Ir a Estudiar", finalExam: "Examen Final", exit: "Salir", saveResult: "Guardar Resultado", quizFinished: "¬°Finalizada! üéâ", backQuiz: "Volver", profGemini: "PROFE AI", loadingVoice: "Cargando voz...", personalTutor: "Tu Profe Personal", historyBtn: "üìú Historial", chatPlaceholder: "Escribe tu duda...", searchPlaceholder: "‚ú® Busca aqu√≠...", points: "Puntos", won: "GANADO", question: "Pregunta", correct: "¬°Correcto!", tryAgain: "Intenta otra vez", thinking: "Pensando...", voiceBasic: "Voz b√°sica...", greeting: "¬°Hola! Soy Robi. üçé", namePrompt: "¬øCu√°l es tu nombre?", nameSubtitle: "Ser√© tu tutor personal.", nameSubmit: "¬°Empezar!" },
            en: { preparing: "Preparing...", appTitle: "[NAME]'s World", welcome: "Hello, [NAME]! üëã", subtitle: "Discover today?", tabLessons: "üìö Lessons", tabQuizzes: "üß† Quizzes", factTitle: "Fun Fact:", loading: "Loading...", go: "Go", recent: "Recent:", explore: "Explore", trophies: "Trophies", loadMore: "üåü Generate more! üåü", back: "Back", preparingLesson: "Robi is preparing...", errorTitle: "Oops!", errorDesc: "Problem.", retry: "Retry", letsPractice: "Let's Practice!", regenerate: "Longer Version", complete: "Done!", moreInfo: "üëá Explore", quizZone: "Quiz Zone", quizDesc: "Show knowledge!", quizHistory: "History:", noQuizHistory: "No quizzes.", startQuiz: "üöÄ Start Quiz", goToStudy: "Go Study", finalExam: "Exam", exit: "Exit", saveResult: "Save", quizFinished: "Finished! üéâ", backQuiz: "Back", profGemini: "GEMINI", loadingVoice: "Loading voice...", personalTutor: "Tutor", historyBtn: "üìú History", chatPlaceholder: "Type...", searchPlaceholder: "‚ú® Search...", points: "Points", won: "WON", question: "Question", correct: "Correct!", tryAgain: "Try again", thinking: "Thinking...", voiceBasic: "Basic voice...", greeting: "Hi! I'm Robi. üçé", namePrompt: "Name?", nameSubtitle: "Your tutor.", nameSubmit: "Start!" }
        };

        window.b64ToBuf = function(b64) { const bin=atob(b64); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
        window.pcmToWav = function(pcm) { const buf=new ArrayBuffer(44+pcm.length*2); const view=new DataView(buf); const writeString=(o,s)=>{for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i))}; writeString(0,'RIFF');view.setUint32(4,36+pcm.length*2,true);writeString(8,'WAVE');writeString(12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,1,true);view.setUint32(24,24000,true);view.setUint32(28,48000,true);view.setUint16(32,2,true);view.setUint16(34,16,true);writeString(36,'data');view.setUint32(40,pcm.length*2,true);for(let i=0;i<pcm.length;i++)view.setInt16(44+i*2,pcm[i],true);return new Blob([view],{type:'audio/wav'}); }
        
        function stripEmojis(str) {
            if(!str) return "";
            return str.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
        }

        // --- HELPER PARA SONIDOS ---
        function playClickSound() { document.getElementById('sfx-click').play().catch(()=>{}); }
        function playWinSound() { document.getElementById('sfx-win').play().catch(()=>{}); }
        function playCorrectSound() { document.getElementById('sfx-correct').play().catch(()=>{}); }
        function playWrongSound() { document.getElementById('sfx-wrong').play().catch(()=>{}); }
        
        // Make sound functions globally available
        window.playClickSound = playClickSound;
        window.playWinSound = playWinSound;
        window.playCorrectSound = playCorrectSound;
        window.playWrongSound = playWrongSound;
        
        function toggleMusic() {
            const bg = document.getElementById('bg-music');
            const btn = document.getElementById('music-btn');
            if(bg.paused) {
                bg.volume = 0.05; // VOLUMEN AL 5%
                bg.play().catch(()=>{});
                btn.innerText = "üéµ";
                btn.style.opacity = "1";
            } else {
                bg.pause();
                btn.innerText = "üîá";
                btn.style.opacity = "0.5";
            }
        }
        
        // Make toggleMusic globally available
        window.toggleMusic = toggleMusic;

        function updateUI() {
            const t = i18n[state.lang];
            const userName = state.userName || 'Mikhail';
            
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.textContent = t[key]; });
            
            document.getElementById('welcome-greeting').textContent = t.welcome.replace('[NAME]', userName);
            document.getElementById('app-title-display').textContent = t.appTitle.replace('[NAME]', userName);

            document.getElementById('topic-search').placeholder = t.searchPlaceholder;
            document.getElementById('chat-input').placeholder = t.chatPlaceholder;
            const nameField = document.getElementById('nameInputField'); if(nameField) nameField.placeholder = state.lang === 'es' ? 'Tu Nombre' : 'Your Name';
            const flagSrc = state.lang === 'es' ? 'https://flagcdn.com/w40/mx.png' : 'https://flagcdn.com/w40/us.png';
            const langText = state.lang.toUpperCase();
            if (document.getElementById('lang-toggle')) { document.querySelector('#lang-toggle .flag-icon').src = flagSrc; document.querySelector('#lang-toggle span').textContent = langText; }
            if (document.getElementById('lang-toggle-intro')) { document.querySelector('#lang-toggle-intro .flag-icon').src = flagSrc; document.querySelector('#lang-toggle-intro span').textContent = langText; }
            document.getElementById('points-display').textContent = `${state.points} ${t.points}`;
            document.getElementById('assistant-btn').style.backgroundImage = `url('${robiIconUrl}')`;
            document.getElementById('chat-header-icon').style.backgroundImage = `url('${robiIconUrl}')`;
            updateFactUI(); renderMosaics(); renderBranches(); renderHistory(); renderQuizHistory(); renderSearchHistory(); renderMenuHistory();
        }

        function getImageUrl(topicEn) { 
            // Use the generateImage function for dynamic image generation
            // Falls back to Pollinations if DALL-E fails
            return `https://image.pollinations.ai/prompt/illustration%20of%20${encodeURIComponent(topicEn)}%20vector%20flat%20colorful?width=600&height=400&nologo=true`; 
        }
        
        /**
         * Get AI-generated image URL with DALL-E fallback to Pollinations
         * @param {string} topic - The topic for image generation
         * @returns {Promise<string>} - Image URL
         */
        async function getAIImageUrl(topic) {
            return await generateImage(topic);
        }

        function initFacts() { state.currentFacts = [...BASE_FACTS].sort(() => 0.5 - Math.random()).slice(0, 5); state.currentFactIndex = 0; updateFactUI(); }
        function getTranslatedFact(factObj) { return factObj[state.lang] || factObj.es; }
        function updateFactUI() { if(state.currentFacts.length === 0) initFacts(); const factObj = state.currentFacts[state.currentFactIndex]; const factText = getTranslatedFact(factObj); const el = document.getElementById('daily-fact'); el.style.opacity = '0'; setTimeout(() => { el.innerText = factText; el.style.opacity = '1'; document.getElementById('fact-counter').innerText = `${state.currentFactIndex + 1}/5`; }, 200); }
        document.getElementById('next-fact').onclick = () => { if(state.currentFactIndex < 4) { state.currentFactIndex++; updateFactUI(); } else { state.currentFacts = [...BASE_FACTS].sort(() => 0.5 - Math.random()).slice(0, 5); state.currentFactIndex = 0; updateFactUI(); } };
        document.getElementById('prev-fact').onclick = () => { if(state.currentFactIndex > 0) { state.currentFactIndex--; updateFactUI(); } };

        function renderMosaics(topicList = null, containerId = 'category-mosaics') {
            const container = document.getElementById(containerId); 
            if(!container) return;
            if (!topicList && state.itemsToShow === 9) container.innerHTML = '';
            else if(topicList) container.innerHTML = ''; 

            const list = topicList || (state.lang === 'es' ? STATIC_TOPICS_ES : STATIC_TOPICS_EN);
            
            let start = 0;
            let end = list.length;
            
            if (!topicList) {
                if(state.itemsToShow > 9 && container.children.length > 0) start = container.children.length;
                end = Math.min(state.itemsToShow, list.length);
            }

            for(let i=start; i < end; i++) {
                const topic = list[i]; 
                const topicEn = topic; 
                const img = getImageUrl(topicEn);
                
                const card = document.createElement('div'); 
                card.className = "topic-card animate-fade-in"; 
                
                card.innerHTML = `
                    <div class="topic-image" style="background-image: url('${img}')"></div>
                    <div class="topic-overlay">
                        <span class="font-bold text-white text-2xl fun-font drop-shadow-md tracking-wide mb-1 leading-tight">${topic}</span>
                        <button class="topic-btn">Ver Lecci√≥n</button>
                    </div>
                `;
                const load = () => loadLesson(topic, topic, topicEn, img, false);
                const overlay = card.querySelector('.topic-overlay');
                overlay.onclick = (e) => { e.stopPropagation(); playClickSound(); load(); };
                container.appendChild(card);
            }
            
            const loadMoreBtn = document.getElementById('load-more-btn');
            if(loadMoreBtn) {
                loadMoreBtn.style.display = 'block';
                if(topicList) {
                    loadMoreBtn.innerText = "üåü ¬°Generar nuevos temas! üåü";
                    loadMoreBtn.onclick = () => { playClickSound(); generateMoreTopicsForBranch(); };
                } else {
                    loadMoreBtn.innerText = "üåü ¬°Ver m√°s cosas! üåü";
                    loadMoreBtn.onclick = () => { playClickSound(); state.itemsToShow += 9; renderMosaics(null, 'category-mosaics'); };
                }
            }
        }

        async function generateMoreTopicsForBranch() {
            // Placeholder for generation logic
        }

        function renderBranches() {
            const container = document.getElementById('branches-grid'); 
            if(!container) return;
            container.innerHTML = '';
            BRANCHES.forEach(branch => {
                const btn = document.createElement('div');
                btn.className = "bg-white border-2 border-slate-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-sm hover:border-blue-300 transition hover:shadow-md h-32 active:scale-95";
                btn.innerHTML = `<div class="text-4xl mb-1">${branch.icon}</div><span class="font-bold text-slate-700 text-center text-sm">${branch.name}</span>`;
                btn.onclick = () => { 
                    playClickSound();
                    document.getElementById('section-branches').classList.add('hidden');
                    document.getElementById('section-explore').classList.remove('hidden');
                    document.getElementById('clear-filter-container').classList.remove('hidden');
                    
                    const subtopics = BRANCH_TOPICS[branch.name] || ["General"];
                    state.currentBranch = branch.name;
                    renderMosaics(subtopics, 'category-mosaics');
                    
                    document.getElementById('subtab-explore').classList.add('text-blue-600','border-blue-600'); 
                    document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600');
                };
                container.appendChild(btn);
            });
        }

        document.getElementById('clear-filter-btn').onclick = () => {
            playClickSound();
            document.getElementById('clear-filter-container').classList.add('hidden');
            state.currentBranch = null;
            state.itemsToShow = 9; 
            document.getElementById('category-mosaics').innerHTML = '';
            renderMosaics(null, 'category-mosaics');
        };

        function renderHistory() {
            const cont = document.getElementById('learned-gallery'); if(!cont) return; cont.innerHTML = ''; if(state.history.length === 0) { cont.innerHTML = `<p class="text-slate-400 font-medium text-center col-span-full py-8 text-xl">...</p>`; return; }
            const t = i18n[state.lang];
            state.history.forEach(item => { const card = document.createElement('div'); card.className = "bg-white border-0 rounded-2xl p-4 flex flex-col justify-between h-32 active:scale-95 transition cursor-pointer relative overflow-hidden group shadow-md"; card.innerHTML = `<div class="absolute top-0 right-0 px-3 py-1 bg-amber-400 text-white rounded-bl-xl text-xs font-bold shadow-sm">üèÜ ${t.won}</div><h3 class="font-bold text-slate-700 text-lg group-hover:text-blue-600 line-clamp-2">${item.displayTopic}</h3><p class="text-xs text-slate-400 font-bold">${new Date(item.date).toLocaleDateString()}</p>`; card.onclick = () => loadLesson(item.displayTopic, item.topicEs, item.topicEn, getImageUrl(item.topicEn), false); cont.appendChild(card); });
        }

        function renderMenuHistory() {
            const list = document.getElementById('menu-history-list');
            if(!list) return;
            list.innerHTML = '';
            state.history.slice(0, 8).forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-slate-50 p-2 rounded-lg text-sm font-bold text-slate-600 truncate cursor-pointer hover:bg-slate-100";
                div.textContent = item.displayTopic;
                div.onclick = () => {
                    playClickSound();
                    document.getElementById('side-menu-overlay').classList.remove('open');
                    loadLesson(item.displayTopic, item.topicEs, item.topicEn, getImageUrl(item.topicEn), false);
                };
                list.appendChild(div);
            });
            const trophyList = document.getElementById('menu-trophies-list');
            if(trophyList) {
                trophyList.innerHTML = '';
                const totalTrophies = state.history.length;
                for(let i=0; i<Math.min(totalTrophies, 8); i++) {
                    const t = document.createElement('div');
                    t.className = "bg-amber-100 rounded-lg aspect-square flex items-center justify-center text-xl shadow-sm border border-amber-200";
                    t.innerText = "üèÜ";
                    trophyList.appendChild(t);
                }
            }
        }

        function renderQuizHistory() {
            const list = document.getElementById('quiz-history-list'); if(!list) return; list.innerHTML = ''; const t = i18n[state.lang];
            if(state.quizHistory.length === 0) { list.innerHTML = `<p>${t.noQuizHistory}</p>`; return; }
            state.quizHistory.forEach(q => { const div = document.createElement('div'); div.className = 'quiz-history-item p-3 mb-2 bg-slate-50 rounded-xl flex justify-between'; div.innerHTML = `<div><p class="font-bold text-slate-700">${q.topic}</p><p class="text-xs text-slate-400">${new Date(q.date).toLocaleDateString()}</p></div><div class="font-bold text-green-600 text-lg">+${q.score}</div>`; list.appendChild(div); });
        }
        
        function renderSearchHistory() {
            const container = document.getElementById('search-history-container'); 
            const tagsDiv = document.getElementById('search-history-tags'); 
            if(!tagsDiv) return; 
            tagsDiv.innerHTML = '';
            
            if(state.searchHistory.length > 0) { 
                container.classList.remove('hidden'); 
                const recent = [...new Set(state.searchHistory)].slice(0, 5); 
                recent.forEach(term => { 
                    const wrapper = document.createElement('span'); 
                    wrapper.className = "search-tag";
                    
                    const text = document.createElement('span');
                    text.textContent = term;
                    text.onclick = () => { playClickSound(); document.getElementById('topic-search').value = term; document.getElementById('search-btn').click(); };
                    
                    const delBtn = document.createElement('span');
                    delBtn.innerHTML = "√ó";
                    delBtn.className = "tag-delete";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        playClickSound();
                        state.searchHistory = state.searchHistory.filter(t => t !== term);
                        localStorage.setItem('searchHist', JSON.stringify(state.searchHistory));
                        renderSearchHistory();
                    };

                    wrapper.appendChild(text);
                    wrapper.appendChild(delBtn);
                    tagsDiv.appendChild(wrapper); 
                }); 
            } else { 
                container.classList.add('hidden'); 
            }
        }

        // SIMULATED API RESPONSE (REPLACE WITH SERVERLESS IN PROD)
        async function loadLesson(displayTopic, topicEs, topicEn, imgUrl, isMagicMode) {
             // Using AI generation with fallback flow
             
             const t = i18n[state.lang];
             
             // Limpiar buscador
             document.getElementById('topic-search').value = "";
             
             document.getElementById('main-header').classList.add('hidden'); 
             document.getElementById('main-tabs').classList.add('hidden');
             document.getElementById('discoveryContainer').style.display = 'none'; 
             document.getElementById('lessonDetailContainer').style.display = 'block'; 
             
             document.getElementById('lesson-content-wrapper').classList.add('hidden'); 
             document.getElementById('lesson-error-state').classList.add('hidden'); 
             document.getElementById('lesson-loader').classList.remove('hidden'); 
             window.scrollTo(0,0);
             
             document.getElementById('lesson-title').textContent = displayTopic; 
             document.getElementById('lesson-header-bg').style.backgroundImage = `url('${imgUrl}')`;
             
             try {
                 // Try to get AI-generated image
                 const aiImageUrl = await getAIImageUrl(displayTopic);
                 if (aiImageUrl) {
                     document.getElementById('lesson-header-bg').style.backgroundImage = `url('${aiImageUrl}')`;
                 }
             } catch (error) {
                 // Keep the original image URL if AI image fails
             }
             
             try {
                 // Generate lesson content using AI with fallback
                 const lessonData = await generateLessonContent(displayTopic, state.lang);
                 
                 renderLessonContent(lessonData);
                 state.currentLesson = { ...lessonData, displayTopic, topicEs, topicEn, imgUrl };
                 
                 // Add to search history
                 if (!state.searchHistory.includes(displayTopic)) {
                     state.searchHistory.unshift(displayTopic);
                     state.searchHistory = state.searchHistory.slice(0, 10);
                     localStorage.setItem('searchHist', JSON.stringify(state.searchHistory));
                     renderSearchHistory();
                 }
             } catch (error) {
                 // Show error state if all API calls fail
                 document.getElementById('lesson-loader').classList.add('hidden');
                 document.getElementById('lesson-error-state').classList.remove('hidden');
                 
                 // Set up retry button
                 document.getElementById('retry-lesson-btn').onclick = () => {
                     playClickSound();
                     loadLesson(displayTopic, topicEs, topicEn, imgUrl, isMagicMode);
                 };
             }
        }

        function renderLessonContent(data) {
            document.getElementById('lesson-loader').classList.add('hidden'); document.getElementById('lesson-content-wrapper').classList.remove('hidden'); document.getElementById('lesson-content').innerHTML = data.lesson;
            
            // Set up "Read for me" button with AI voice
            document.getElementById('read-for-me-btn').onclick = () => { 
                playClickSound(); 
                speak(data.lesson); 
            };
            
            const qList = document.getElementById('lesson-questions-list'); qList.innerHTML = '';
            if(data.questions) { data.questions.forEach((item, idx) => { const qContainer = document.createElement('div'); qContainer.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"; let optionsHtml = ''; item.options.forEach((opt, optIdx) => { optionsHtml += `<div class="quiz-option mt-2" onclick="checkLessonAnswer(this, ${optIdx === item.correct}, '${opt.replace(/'/g, "\\'")}')">${opt}</div>`; }); qContainer.innerHTML = `<div class="flex justify-between items-center mb-3"><p class="font-bold text-lg text-slate-800">‚ùì ${item.q}</p><button class="text-blue-400 hover:text-blue-600 text-xl" onclick="speak('${item.q.replace(/'/g, "\\'")}')">üîä</button></div><div class="mt-2 space-y-2">${optionsHtml}</div>`; qList.appendChild(qContainer); }); }
            
            // Render related topics
            const subcatList = document.getElementById('subcategories-list');
            if (subcatList && data.related) {
                subcatList.innerHTML = '';
                data.related.forEach(topic => {
                    const btn = document.createElement('button');
                    btn.className = "bg-blue-50 text-blue-600 px-4 py-2 rounded-full font-bold text-sm hover:bg-blue-100 transition cursor-pointer";
                    btn.textContent = topic;
                    btn.onclick = () => {
                        playClickSound();
                        loadLesson(topic, topic, topic, getImageUrl(topic), false);
                    };
                    subcatList.appendChild(btn);
                });
            }
        }
        
        document.getElementById('generate-button').onclick = () => { if(state.currentLesson) loadLesson(state.currentLesson.displayTopic, state.currentLesson.topicEs, state.currentLesson.topicEn, state.currentLesson.imgUrl, true); };
        
        window.checkLessonAnswer = function(el, isCorrect, text) { const t = i18n[state.lang]; if(el.classList.contains('correct') || el.classList.contains('wrong')) return; if(isCorrect) { el.classList.add('correct'); playCorrectSound(); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); } else { el.classList.add('wrong'); playWrongSound(); } };

        document.getElementById('start-random-quiz').onclick = async () => { 
            playClickSound();
            
            const quizContainer = document.getElementById('quiz-container');
            const quizPlaceholder = document.getElementById('quiz-placeholder');
            const quizQuestionsList = document.getElementById('quiz-questions-list');
            const quizTopicTitle = document.getElementById('quiz-topic-title');
            const finishBtn = document.getElementById('finish-quiz-btn');
            const quizResult = document.getElementById('quiz-result');
            
            // Show quiz container, hide placeholder
            quizPlaceholder.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            quizResult.classList.add('hidden');
            finishBtn.classList.add('hidden');
            quizQuestionsList.innerHTML = '<div class="text-center py-8"><div class="text-4xl animate-bounce mb-4">üß†</div><p class="text-slate-500 font-bold">Generando quiz...</p></div>';
            
            // Pick a random topic
            const topics = state.lang === 'es' ? STATIC_TOPICS_ES : STATIC_TOPICS_EN;
            const randomTopic = topics[Math.floor(Math.random() * topics.length)];
            quizTopicTitle.textContent = randomTopic;
            
            try {
                // Generate quiz using AI
                const prompt = state.lang === 'es'
                    ? `Genera 5 preguntas de quiz para ni√±os sobre "${randomTopic}". Formato JSON:
                       {"questions": [{"q": "pregunta", "options": ["a", "b", "c", "d"], "correct": 0}]}`
                    : `Generate 5 quiz questions for children about "${randomTopic}". JSON format:
                       {"questions": [{"q": "question", "options": ["a", "b", "c", "d"], "correct": 0}]}`;
                
                const response = await generateText(prompt, state.lang);
                
                let quizData;
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        quizData = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    // Use fallback quiz
                }
                
                if (!quizData || !quizData.questions) {
                    // Fallback quiz
                    quizData = {
                        questions: [
                            { q: state.lang === 'es' ? `¬øQu√© es ${randomTopic}?` : `What is ${randomTopic}?`, options: [randomTopic, "Algo m√°s", "No s√©", "Otra cosa"], correct: 0 },
                            { q: state.lang === 'es' ? "¬øTe gusta aprender?" : "Do you like learning?", options: [state.lang === 'es' ? "S√≠" : "Yes", "No", state.lang === 'es' ? "A veces" : "Sometimes", state.lang === 'es' ? "Siempre" : "Always"], correct: 0 }
                        ]
                    };
                }
                
                // Render quiz questions
                quizQuestionsList.innerHTML = '';
                let answeredCount = 0;
                let correctCount = 0;
                
                quizData.questions.forEach((item, idx) => {
                    const qContainer = document.createElement('div');
                    qContainer.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm";
                    qContainer.innerHTML = `
                        <p class="font-bold text-lg text-slate-800 mb-4">${idx + 1}. ${item.q}</p>
                        <div class="space-y-2">
                            ${item.options.map((opt, optIdx) => `
                                <div class="quiz-option" data-correct="${optIdx === item.correct}" data-idx="${idx}">${opt}</div>
                            `).join('')}
                        </div>
                    `;
                    quizQuestionsList.appendChild(qContainer);
                });
                
                // Add click handlers
                quizQuestionsList.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.onclick = function() {
                        if (this.classList.contains('correct') || this.classList.contains('wrong')) return;
                        
                        const isCorrect = this.dataset.correct === 'true';
                        const siblings = this.parentElement.querySelectorAll('.quiz-option');
                        
                        siblings.forEach(s => s.style.pointerEvents = 'none');
                        
                        if (isCorrect) {
                            this.classList.add('correct');
                            playCorrectSound();
                            correctCount++;
                        } else {
                            this.classList.add('wrong');
                            playWrongSound();
                            // Show correct answer
                            siblings.forEach(s => {
                                if (s.dataset.correct === 'true') s.classList.add('correct');
                            });
                        }
                        
                        answeredCount++;
                        if (answeredCount === quizData.questions.length) {
                            finishBtn.classList.remove('hidden');
                        }
                    };
                });
                
                // Finish button handler
                finishBtn.onclick = () => {
                    playClickSound();
                    const score = correctCount * 10;
                    state.points += score;
                    localStorage.setItem('userPoints', state.points);
                    
                    state.quizHistory.unshift({
                        topic: randomTopic,
                        score: score,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('quizHist', JSON.stringify(state.quizHistory));
                    
                    quizResult.classList.remove('hidden');
                    document.getElementById('quiz-score-text').textContent = `+${score} ${state.lang === 'es' ? 'Puntos' : 'Points'}`;
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    playWinSound();
                    updateUI();
                };
                
            } catch (error) {
                quizQuestionsList.innerHTML = `<div class="text-center py-8"><div class="text-4xl mb-4">üòÖ</div><p class="text-slate-500 font-bold">${state.lang === 'es' ? 'Error al generar quiz. Intenta de nuevo.' : 'Error generating quiz. Try again.'}</p></div>`;
            }
        };
        
        window.exitQuiz = function() {
            playClickSound();
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-placeholder').classList.remove('hidden');
            document.getElementById('quiz-result').classList.add('hidden');
            renderQuizHistory();
        };

        // --- INICIALIZACI√ìN ---
        
        function toggleLangIntro() { playClickSound(); state.lang = state.lang==='es'?'en':'es'; localStorage.setItem('appLang', state.lang); updateUI(); }
        
        function startApp() {
             try {
                document.getElementById('global-loader').style.display = 'none';
                
                if (state.userName && state.userName.trim() !== "") {
                    document.getElementById('nameInputScreen').style.display = 'none'; 
                    document.getElementById('app-container').style.display = 'block'; 
                    document.getElementById('app-container').style.paddingTop = '80px'; 
                    document.getElementById('app-container').style.opacity = '1'; 
                    updateUI();
                    const bg = document.getElementById('bg-music');
                    if(bg) { bg.volume = 0.05; bg.play().catch(()=>{}); }
                } else {
                    document.getElementById('nameInputScreen').style.display = 'flex'; 
                    document.getElementById('app-container').style.display = 'none'; 
                    updateUI(); 
                }
            } catch (e) { console.log(e); }
        }
        
        document.getElementById('nameSubmitBtn').onclick = () => { 
            playClickSound();
            const nameInput = document.getElementById('nameInputField').value.trim(); 
            if (nameInput) { 
                state.userName = nameInput.split(' ')[0]; 
                localStorage.setItem('userName', state.userName); 
                startApp(); 
                const bg = document.getElementById('bg-music');
                if(bg) { bg.volume = 0.05; bg.play().catch(()=>{}); }
            } 
        };
        document.getElementById('reset-user-btn').onclick = () => { localStorage.removeItem('userName'); sessionStorage.clear(); location.reload(); };

        document.addEventListener('DOMContentLoaded', () => {
            const langToggleMain = document.getElementById('lang-toggle'); if (langToggleMain) langToggleMain.onclick = toggleLangIntro; 
            const langToggleIntro = document.getElementById('lang-toggle-intro'); if (langToggleIntro) langToggleIntro.onclick = toggleLangIntro;
            
            setTimeout(() => { startApp(); }, 500); 
            
            const switchTab = (active) => {
                document.getElementById('tab-lesson').className = active==='lesson' ? "btn-fun shadow-blue-400 ring-4 ring-blue-50" : "btn-secondary-fun";
                document.getElementById('tab-quiz').className = active==='quiz' ? "btn-fun shadow-blue-400 ring-4 ring-blue-50" : "btn-secondary-fun";
                document.getElementById('lessonView').style.display = active==='lesson' ? 'block' : 'none';
                document.getElementById('quizView').style.display = active==='quiz' ? 'block' : 'none';
                
                if(active === 'quiz') { 
                    document.getElementById('main-header').classList.add('hidden'); 
                    document.getElementById('main-tabs').classList.add('hidden');
                } else if(active === 'lesson') {
                    if(document.getElementById('discoveryContainer').style.display !== 'none') {
                         document.getElementById('main-header').classList.remove('hidden'); 
                         document.getElementById('main-tabs').classList.remove('hidden');
                    }
                }
            };
            document.getElementById('tab-lesson').onclick = () => { playClickSound(); switchTab('lesson'); };
            document.getElementById('tab-quiz').onclick = () => { playClickSound(); switchTab('quiz'); };
            document.getElementById('load-more-btn').onclick = () => { playClickSound(); state.itemsToShow += 9; renderMosaics(null, 'category-mosaics'); };
            document.getElementById('search-btn').onclick = () => { playClickSound(); const v = document.getElementById('topic-search').value; if(v) loadLesson(v, v, v, getImageUrl(v), false); };
            document.getElementById('topic-search').onkeypress = (e) => { if(e.key==='Enter') document.getElementById('search-btn').click(); };
            document.getElementById('back-button').onclick = () => { 
                playClickSound();
                document.getElementById('lessonDetailContainer').style.display = 'none'; document.getElementById('discoveryContainer').style.display = 'block'; 
                document.getElementById('main-header').classList.remove('hidden'); document.getElementById('main-tabs').classList.remove('hidden');
                window.scrollTo(0,0); 
            };
            // ... Resto de eventos de pesta√±as ...
            document.getElementById('subtab-explore').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.remove('hidden'); document.getElementById('section-trophies').classList.add('hidden'); document.getElementById('section-branches').classList.add('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-trophies').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600');
                renderMosaics(null, 'category-mosaics'); 
                document.getElementById('load-more-btn').style.display = 'block';
                document.getElementById('clear-filter-container').classList.add('hidden');
            };
            document.getElementById('subtab-branches').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.add('hidden'); document.getElementById('section-trophies').classList.add('hidden'); document.getElementById('section-branches').classList.remove('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-trophies').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-explore').classList.remove('text-blue-600','border-blue-600');
            };
            document.getElementById('subtab-trophies').onclick = (e) => { 
                playClickSound();
                document.getElementById('section-explore').classList.add('hidden'); document.getElementById('section-trophies').classList.remove('hidden'); document.getElementById('section-branches').classList.add('hidden');
                e.target.classList.add('text-blue-600','border-blue-600'); document.getElementById('subtab-explore').classList.remove('text-blue-600','border-blue-600'); document.getElementById('subtab-branches').classList.remove('text-blue-600','border-blue-600'); renderHistory(); 
            };
            
            // ============================================
            // CHAT FUNCTIONALITY
            // ============================================
            const chatOverlay = document.getElementById('chat-overlay');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat');
            const closeChatBtn = document.getElementById('close-chat');
            const minimizeChatBtn = document.getElementById('minimize-chat');
            const assistantBtn = document.getElementById('assistant-btn');
            const voiceChatBtn = document.getElementById('voice-chat-btn');
            
            // Open chat
            assistantBtn.onclick = () => {
                playClickSound();
                chatOverlay.classList.add('open');
                
                // Add greeting if chat is empty
                if (chatMessages.children.length === 0) {
                    const greeting = state.lang === 'es' 
                        ? '¬°Hola! Soy Robi, tu profe personal. üçé ¬øEn qu√© puedo ayudarte hoy?'
                        : 'Hello! I\'m Robi, your personal tutor. üçé How can I help you today?';
                    addChatMessage(greeting, 'assistant');
                }
            };
            
            // Close chat
            closeChatBtn.onclick = () => {
                playClickSound();
                chatOverlay.classList.remove('open');
            };
            
            minimizeChatBtn.onclick = () => {
                playClickSound();
                chatOverlay.classList.remove('open');
            };
            
            // Click outside to close
            chatOverlay.onclick = (e) => {
                if (e.target === chatOverlay) {
                    chatOverlay.classList.remove('open');
                }
            };
            
            // Add chat message helper
            function addChatMessage(text, sender) {
                const msgDiv = document.createElement('div');
                msgDiv.className = sender === 'user' 
                    ? 'flex justify-end'
                    : 'flex justify-start';
                
                const bubble = document.createElement('div');
                bubble.className = sender === 'user'
                    ? 'bg-blue-600 text-white rounded-2xl rounded-br-sm px-4 py-2 max-w-[80%] text-sm'
                    : 'bg-white text-slate-700 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%] text-sm shadow-sm border border-slate-100';
                
                bubble.innerHTML = text;
                
                // Add speak button for assistant messages
                if (sender === 'assistant') {
                    const speakBtn = document.createElement('button');
                    speakBtn.className = 'ml-2 text-blue-400 hover:text-blue-600 text-sm';
                    speakBtn.innerHTML = 'üîä';
                    speakBtn.onclick = () => speak(text);
                    bubble.appendChild(speakBtn);
                }
                
                msgDiv.appendChild(bubble);
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Send message
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                playClickSound();
                addChatMessage(message, 'user');
                chatInput.value = '';
                
                // Add thinking indicator
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'flex justify-start';
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.innerHTML = `<div class="bg-white text-slate-400 rounded-2xl px-4 py-2 text-sm animate-pulse">${state.lang === 'es' ? 'Pensando...' : 'Thinking...'}</div>`;
                chatMessages.appendChild(thinkingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    // Generate response using AI with fallback
                    const response = await generateChatResponse(message, state.lang);
                    
                    // Remove thinking indicator
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) indicator.remove();
                    
                    // Add AI response
                    addChatMessage(response, 'assistant');
                    
                    // Save to chat history
                    state.chatHistory.push({ role: 'user', content: message });
                    state.chatHistory.push({ role: 'assistant', content: response });
                    
                } catch (error) {
                    // Remove thinking indicator
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) indicator.remove();
                    
                    addChatMessage(state.lang === 'es' 
                        ? '¬°Ups! No pude procesar eso. Intenta de nuevo.'
                        : 'Oops! I couldn\'t process that. Try again.', 
                        'assistant');
                }
            }
            
            sendChatBtn.onclick = sendChatMessage;
            chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendChatMessage(); };
            
            // Voice input for chat
            voiceChatBtn.onclick = () => {
                playClickSound();
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    
                    voiceChatBtn.classList.add('bg-red-500', 'text-white');
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        chatInput.value = transcript;
                        voiceChatBtn.classList.remove('bg-red-500', 'text-white');
                    };
                    
                    recognition.onerror = () => {
                        voiceChatBtn.classList.remove('bg-red-500', 'text-white');
                    };
                    
                    recognition.onend = () => {
                        voiceChatBtn.classList.remove('bg-red-500', 'text-white');
                    };
                    
                    recognition.start();
                } else {
                    alert(state.lang === 'es' 
                        ? 'Tu navegador no soporta reconocimiento de voz.'
                        : 'Your browser doesn\'t support speech recognition.');
                }
            };
            
            // Voice input for search
            const searchMicBtn = document.getElementById('search-mic-btn');
            if (searchMicBtn) {
                searchMicBtn.onclick = () => {
                    playClickSound();
                    
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        const recognition = new SpeechRecognition();
                        
                        recognition.lang = state.lang === 'es' ? 'es-MX' : 'en-US';
                        recognition.interimResults = false;
                        recognition.maxAlternatives = 1;
                        
                        searchMicBtn.style.color = '#ef4444';
                        
                        recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            document.getElementById('topic-search').value = transcript;
                            searchMicBtn.style.color = '';
                        };
                        
                        recognition.onerror = () => {
                            searchMicBtn.style.color = '';
                        };
                        
                        recognition.onend = () => {
                            searchMicBtn.style.color = '';
                        };
                        
                        recognition.start();
                    }
                };
            }
            
            // ============================================
            // AUDIO PLAYER CONTROLS
            // ============================================
            const playerPlayPause = document.getElementById('player-play-pause');
            const playerClose = document.getElementById('player-close');
            const audioPlayer = document.getElementById('sticky-audio-player');
            
            playerPlayPause.onclick = () => {
                playClickSound();
                
                if (state.audioSource) {
                    if (state.isPlaying) {
                        state.audioSource.pause();
                        state.isPlaying = false;
                        playerPlayPause.textContent = '‚ñ∂';
                    } else {
                        state.audioSource.play();
                        state.isPlaying = true;
                        playerPlayPause.textContent = '‚è∏';
                    }
                } else if ('speechSynthesis' in window) {
                    if (speechSynthesis.speaking && !speechSynthesis.paused) {
                        speechSynthesis.pause();
                        state.isPlaying = false;
                        playerPlayPause.textContent = '‚ñ∂';
                    } else if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                        state.isPlaying = true;
                        playerPlayPause.textContent = '‚è∏';
                    }
                }
            };
            
            playerClose.onclick = () => {
                playClickSound();
                
                if (state.audioSource) {
                    state.audioSource.pause();
                    state.audioSource = null;
                }
                
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
                
                state.isPlaying = false;
                audioPlayer.classList.remove('visible');
            };
            
            // ============================================
            // COMPLETE LESSON BUTTON
            // ============================================
            const completeBtn = document.getElementById('complete-button');
            if (completeBtn) {
                completeBtn.onclick = () => {
                    playClickSound();
                    
                    if (state.currentLesson) {
                        // Add points
                        state.points += 50;
                        localStorage.setItem('userPoints', state.points);
                        
                        // Add to history
                        const historyItem = {
                            displayTopic: state.currentLesson.displayTopic,
                            topicEs: state.currentLesson.topicEs,
                            topicEn: state.currentLesson.topicEn,
                            date: new Date().toISOString()
                        };
                        
                        // Check if already in history
                        if (!state.history.some(h => h.displayTopic === historyItem.displayTopic)) {
                            state.history.unshift(historyItem);
                            state.history = state.history.slice(0, 20);
                            localStorage.setItem('lessonHist', JSON.stringify(state.history));
                        }
                        
                        // Celebrate
                        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                        playWinSound();
                        
                        // Update UI
                        updateUI();
                        
                        // Go back to discovery
                        setTimeout(() => {
                            document.getElementById('lessonDetailContainer').style.display = 'none';
                            document.getElementById('discoveryContainer').style.display = 'block';
                            document.getElementById('main-header').classList.remove('hidden');
                            document.getElementById('main-tabs').classList.remove('hidden');
                            window.scrollTo(0, 0);
                        }, 1500);
                    }
                };
            }
            
            // ============================================
            // HOME BUTTON
            // ============================================
            const homeBtn = document.getElementById('home-btn');
            if (homeBtn) {
                homeBtn.onclick = () => {
                    playClickSound();
                    document.getElementById('lessonDetailContainer').style.display = 'none';
                    document.getElementById('discoveryContainer').style.display = 'block';
                    document.getElementById('main-header').classList.remove('hidden');
                    document.getElementById('main-tabs').classList.remove('hidden');
                    document.getElementById('lessonView').style.display = 'block';
                    document.getElementById('quizView').style.display = 'none';
                    document.getElementById('quiz-container').classList.add('hidden');
                    document.getElementById('quiz-placeholder').classList.remove('hidden');
                    document.getElementById('tab-lesson').className = "btn-fun shadow-blue-400 ring-4 ring-blue-50";
                    document.getElementById('tab-quiz').className = "btn-secondary-fun";
                    window.scrollTo(0, 0);
                };
            }
            
            // ============================================
            // MENU BUTTON
            // ============================================
            const menuBtn = document.getElementById('menu-btn');
            if (menuBtn) {
                menuBtn.onclick = () => {
                    playClickSound();
                    document.getElementById('side-menu-overlay').classList.add('open');
                };
            }
            
            // Load saved data from localStorage
            try {
                state.points = parseInt(localStorage.getItem('userPoints')) || 0;
                state.history = JSON.parse(localStorage.getItem('lessonHist')) || [];
                state.quizHistory = JSON.parse(localStorage.getItem('quizHist')) || [];
                state.searchHistory = JSON.parse(localStorage.getItem('searchHist')) || [];
            } catch (e) {
                // Use defaults
            }
        });
    </script>
</body>
</html>
